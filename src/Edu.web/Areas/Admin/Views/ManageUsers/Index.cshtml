@model Edu.Web.Areas.Admin.ViewModels.UserIndexViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L
@inject Microsoft.AspNetCore.Identity.UserManager<Edu.Domain.Entities.ApplicationUser> UserManager

@{
    ViewData["Title"] = L["Admin.Users"];
    var currentUserId = UserManager.GetUserId(User);
}

<!-- Header: role filters + totals + search (responsive) -->
<div class="admin-header mb-3">

    <!-- Role filters (scrollable on xs, wraps on md) -->
    <div class="d-flex align-items-center mb-2">
        <div class="d-flex flex-row flex-md-row gap-2 w-100 overflow-auto" style="-webkit-overflow-scrolling: touch;">
            <a class="btn btn-outline-secondary btn-sm rounded role-filter @(Model.CurrentRoleFilter == "All" ? "active" : "")"
               href="@Url.Action("Index", new { role = "All", showDeleted = Model.ShowDeleted, search = Model.Search })"
               title="@L["Common.All"]" aria-label="@L["Common.All"]">
                <i class="fa fa-list me-1" aria-hidden="true"></i>
                <span class="d-none d-md-inline">@L["Common.All"]</span>
                <span class="badge bg-secondary ms-2 d-inline-block">@Model.TotalCount</span>
            </a>

            <a class="btn btn-outline-secondary btn-sm rounded role-filter @(Model.CurrentRoleFilter == "Admin" ? "active" : "")"
               href="@Url.Action("Index", new { role = "Admin", showDeleted = Model.ShowDeleted, search = Model.Search })"
               title="@L["Admin.Admin"]" aria-label="@L["Admin.Admin"]">
                <i class="fa fa-user-shield me-1" aria-hidden="true"></i>
                <span class="d-none d-md-inline">@L["Admin.Admin"]</span>
                <span class="badge bg-danger ms-2 d-inline-block">@Model.AdminCount</span>
            </a>

            <a class="btn btn-outline-secondary btn-sm rounded role-filter @(Model.CurrentRoleFilter == "Teacher" ? "active" : "")"
               href="@Url.Action("Index", new { role = "Teacher", showDeleted = Model.ShowDeleted, search = Model.Search })"
               title="@L["Admin.Teacher"]" aria-label="@L["Admin.Teacher"]">
                <i class="fa fa-chalkboard-teacher me-1" aria-hidden="true"></i>
                <span class="d-none d-md-inline">@L["Admin.Teacher"]</span>
                <span class="badge bg-primary ms-2 d-inline-block">@Model.TeacherCount</span>
            </a>

            <a class="btn btn-outline-secondary btn-sm rounded role-filter @(Model.CurrentRoleFilter == "Student" ? "active" : "")"
               href="@Url.Action("Index", new { role = "Student", showDeleted = Model.ShowDeleted, search = Model.Search })"
               title="@L["Admin.Student"]" aria-label="@L["Admin.Student"]">
                <i class="fa fa-user-graduate me-1" aria-hidden="true"></i>
                <span class="d-none d-md-inline">@L["Admin.Student"]</span>
                <span class="badge bg-success ms-2 d-inline-block">@Model.StudentCount</span>
            </a>
        </div>
    </div>

    <!-- Right-side controls: total, deleted toggle, search -->
    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">

        <!-- Total (visible on md+) -->
        <div class="d-none d-md-flex align-items-center text-muted small me-2">
            <span class="fw-semibold me-1">@L["Admin.Total"]:</span>
            <span class="badge bg-primary me-2">@Model.TotalCount</span>
        </div>

        <!-- Deleted toggle -->
        <div class="btn-group btn-group-sm me-md-2" role="group" aria-label="Deleted filter">
            <a class="btn btn-outline-secondary btn-sm rounded deleted-filter @(Model.ShowDeleted ? "" : "active")"
               href="@Url.Action("Index", new { role = Model.CurrentRoleFilter, showDeleted = false, search = Model.Search })">
                @(L["Admin.ActiveShort"] ?? "Active")
            </a>
            <a class="btn btn-outline-secondary btn-sm rounded deleted-filter @(Model.ShowDeleted ? "active" : "")"
               href="@Url.Action("Index", new { role = Model.CurrentRoleFilter, showDeleted = true, search = Model.Search })">
                @(L["Admin.DeletedShort"] ?? "Deleted")
            </a>
        </div>

        <!-- Search: full width on xs, compact on md+ -->
        <form class="d-flex w-100 w-md-auto" method="get" asp-action="Index" asp-area="Admin">
            <input type="hidden" name="role" value="@Model.CurrentRoleFilter" />
            <input type="hidden" name="showDeleted" value="@(Model.ShowDeleted ? "true" : "false")" />
            <div class="input-group input-group-sm w-100">
                <input type="text" name="search" value="@Model.Search" class="form-control" placeholder="@L["DataTable.Search"]" />
                <button class="btn btn-primary" type="submit">@L["DataTable.Search"]</button>
            </div>
        </form>
    </div>
</div>

<!-- Card container -->
<div class="card shadow-sm">
    <div class="card-body">

        <!-- TABLE for md+ -->
        <div class="table-responsive d-none d-md-block">
            <table id="usersTable" class="table table-hover align-middle w-100 small">
                <thead class="table-light">
                    <tr>
                        <th style="width:50px">#</th>
                        <th style="width:60px">@L["Admin.Image"]</th>
                        <th>@L["Admin.FullName"]</th>
                        <th style="width:140px">@L["Admin.Phone"]</th>
                        <th style="width:200px">@L["Admin.Roles"]</th>
                        <th style="width:280px" class="text-end">@L["Admin.Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Items == null || !Model.Items.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted">— @(L["Admin.NoUsersFound"] ?? "No users found") —</td>
                        </tr>
                    }
                    else
                    {
                        var idx = (Model.PageIndex - 1) * Model.PageSize;
                        foreach (var row in Model.Items)
                        {
                            idx++;
                            <tr class="@(Model.ShowDeleted ? "table-secondary" : "")">
                                <td>@idx</td>
                                <td>
                                    <img src="@(row.PhotoUrl ?? Url.Content("~/uploads/images/default-avatar.jpg"))"
                                         class="rounded-circle avatar-xs" alt="">
                                </td>
                                <td>
                                    <div class="fw-semibold text-truncate-ellipsis" style="max-width:260px;">@row.FullName</div>
                                    <div class="small text-muted text-truncate-ellipsis" style="max-width:260px;">@row.Email</div>
                                </td>
                                <td dir="ltr" class="text-nowrap ltr-phone">
                                    @Html.Raw(string.IsNullOrEmpty(row.PhoneNumber) ? "<span class=\"text-muted\">—</span>" : System.Net.WebUtility.HtmlEncode(row.PhoneNumber))
                                </td>
                                <td>
                                    @{
                                        // defensively parse row.Roles (supports comma / semicolon / pipe separators)
                                        var rolesRaw = (row.Roles ?? string.Empty);
                                        var separators = new[] { ',', ';', '|' };
                                        var roles = rolesRaw
                                        .Split(separators, StringSplitOptions.RemoveEmptyEntries)
                                        .Select(r => r.Trim())
                                        .Where(r => !string.IsNullOrEmpty(r))
                                        .ToList();

                                        // map role identifier -> localized resource
                                        string LocalizeRole(string roleIdentifier)
                                        {
                                            if (string.IsNullOrEmpty(roleIdentifier)) return string.Empty;
                                            switch (roleIdentifier.Trim().ToLowerInvariant())
                                            {
                                                case "admin": return L["Role.Admin"];
                                                case "teacher": return L["Role.Teacher"];
                                                case "student": return L["Role.Student"];
                                                default: return L["Role.Unknown", roleIdentifier]; // fallback: resource with param or the id
                                            }
                                        }
                                    }

                                    <div class="d-flex gap-1 flex-wrap">
                                        @if (!roles.Any())
                                        {
                                            <span class="text-muted small">@L["Role.None"]</span>
                                        }
                                        else
                                        {
                                            foreach (var r in roles)
                                            {
                                                var localized = LocalizeRole(r);
                                                // show as small badge (keeps UI tidy)
                                                <span class="badge bg-secondary text-truncate" style="max-width:160px;">@localized</span>
                                            }
                                        }
                                    </div>
                                </td>

                                <td class="text-end">
                                    <div class="d-flex justify-content-end flex-nowrap gap-1">
                                        <a class="btn btn-sm btn-outline-primary" asp-area="Admin" asp-controller="ManageUsers" asp-action="Details" asp-route-id="@row.Id">@L["Button.View"]</a>

                                        @* Approve/Unapprove toggle for Teacher role *@
                                        @if ((row.Roles ?? "").Split(',').Select(r => r.Trim()).Contains("Teacher"))
                                        {
                                            if (string.Equals(row.TeacherStatus, "Approved", StringComparison.OrdinalIgnoreCase))
                                            {
                                                <form method="post" asp-area="Admin" asp-controller="ManageUsers" asp-action="UnapproveTeacher" class="m-0 d-inline confirm">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@row.Id" />
                                                    <button type="submit" class="btn btn-sm btn-outline-warning text-nowrap">@L["Admin.Unapprove"]</button>
                                                </form>
                                            }
                                            else
                                            {
                                                <form method="post" asp-area="Admin" asp-controller="ManageUsers" asp-action="ApproveTeacher" class="m-0 d-inline confirm">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@row.Id" />
                                                    <button type="submit" class="btn btn-sm btn-outline-success">@L["Button.Approve"]</button>
                                                </form>
                                            }
                                        }

                                        @* Student allow toggle (AJAX) *@
                                        @if (row.IsAllowed.HasValue)
                                        {
                                            <form method="post"
                                                  asp-area="Admin"
                                                  asp-controller="ManageUsers"
                                                  asp-action="ToggleStudentAllowedAjax"
                                                  class="student-allow-form m-0 d-inline"
                                                  data-user-id="@row.Id">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@row.Id" />
                                                <input type="hidden" name="setTo" value="@(row.IsAllowed.Value ? "false" : "true")" class="setToInput" />
                                                <button type="submit"
                                                        class="btn btn-sm student-allow-btn @(row.IsAllowed.Value ? "btn-success" : "btn-outline-secondary")"
                                                        title="@(row.IsAllowed.Value? L["Admin.RevokeAccess"] : L["Admin.AllowAccess"])">
                                                    <i class="fa @(row.IsAllowed.Value ? "fa-check-circle" : "fa-user-lock") me-1" aria-hidden="true"></i>
                                                    <span class="d-none d-md-inline">@((row.IsAllowed.Value ? L["Admin.Allowed"] : L["Admin.NotAllowed"]))</span>
                                                </button>
                                            </form>
                                        }

                                        @{
                                            // determine if the target user has Admin role (case-insensitive)
                                            var isTargetAdmin = (row.Roles ?? "")
                                            .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                            .Select(r => r.Trim())
                                            .Any(r => string.Equals(r, "Admin", StringComparison.OrdinalIgnoreCase));
                                        }

                                        @* Soft-delete / Restore: hide for Admin users *@
                                        @if (!isTargetAdmin)
                                        {
                                            <form method="post" asp-area="Admin" asp-controller="ManageUsers" asp-action="SoftDelete" class="m-0 d-inline confirm">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@row.Id" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    @(Model.ShowDeleted? L["Admin.Restore"] : L["Admin.Suspend"])
                                                </button>
                                            </form>
                                        }

                                        @* Hard delete when viewing deleted (also hide for Admin users) *@
                                        @if (Model.ShowDeleted && !isTargetAdmin)
                                        {
                                            <form method="post" asp-area="Admin" asp-controller="ManageUsers" asp-action="HardDelete" class="m-0 d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@row.Id" />
                                                <button type="submit" class="btn btn-sm btn-danger">@L["Admin.DeletePermanently"]</button>
                                            </form>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- CARDS for small screens -->
        <div class="d-md-none">
            @if (Model.Items == null || !Model.Items.Any())
            {
                <div class="text-center text-muted py-3">— @(L["Admin.NoUsersFound"] ?? "No users found") —</div>
            }
            else
            {
                var cidx = (Model.PageIndex - 1) * Model.PageSize;
                foreach (var row in Model.Items)
                {
                    cidx++;
                    <div class="card mb-2">
                        <div class="card-body card-list-item">
                            <div class="d-flex gap-3">
                                <div class="d-flex flex-column">
                                    <img src="@(row.PhotoUrl ?? Url.Content("~/uploads/images/default-avatar.png"))"
                                         class="avatar-md flex-shrink-0" alt="">
                                    <div class="text-end small text-muted ms-2">#@cidx</div>
                                </div>

                                <div class="flex-grow-1 min-w-0">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="min-w-0">
                                            <div class="fw-semibold text-truncate-ellipsis">@row.FullName</div>
                                            <div class="small text-muted text-truncate-ellipsis">@row.Email</div>
                                        </div>


                                    </div>

                                    <div class="mt-2 small">
                                        <div><strong>@L["Admin.Phone"]:</strong> <span dir="ltr" class="text-truncate ltr-phone">@(string.IsNullOrEmpty(row.PhoneNumber) ? "—" : row.PhoneNumber)</span></div>
                                        <div class="text-truncate">
                                            <strong>@L["Admin.Roles"]:</strong>    @{
                                            // defensively parse row.Roles (supports comma / semicolon / pipe separators)
                                            var rolesRaw = (row.Roles ?? string.Empty);
                                            var separators = new[] { ',', ';', '|' };
                                            var roles = rolesRaw
                                            .Split(separators, StringSplitOptions.RemoveEmptyEntries)
                                            .Select(r => r.Trim())
                                            .Where(r => !string.IsNullOrEmpty(r))
                                            .ToList();

                                            // map role identifier -> localized resource
                                            string LocalizeRole(string roleIdentifier)
                                            {
                                                if (string.IsNullOrEmpty(roleIdentifier)) return string.Empty;
                                                switch (roleIdentifier.Trim().ToLowerInvariant())
                                                {
                                                    case "admin": return L["Role.Admin"];
                                                    case "teacher": return L["Role.Teacher"];
                                                    case "student": return L["Role.Student"];
                                                    default: return L["Role.Unknown", roleIdentifier]; // fallback: resource with param or the id
                                                }
                                            }
                                        }

                                        <div class="d-flex gap-1 flex-wrap">
                                            @if (!roles.Any())
                                            {
                                                <span class="text-muted small">@L["Role.None"]</span>
                                            }
                                            else
                                            {
                                                foreach (var r in roles)
                                                {
                                                    var localized = LocalizeRole(r);
                                                    // show as small badge (keeps UI tidy)
                                                    <span class="badge bg-secondary text-truncate" style="max-width:160px;">@localized</span>
                                                }
                                            }
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- footer: action buttons — full-width on xs, scrollable if overflow -->
                    <div class="card-footer bg-white d-flex flex-nowrap card-action-bar overflow-auto">
                        <a class="btn btn-sm btn-outline-primary flex-shrink-0" asp-area="Admin" asp-controller="ManageUsers" asp-action="Details" asp-route-id="@row.Id">
                            @L["Button.View"]
                        </a>

                        @if ((row.Roles ?? "").Split(',').Select(r => r.Trim()).Contains("Teacher"))
                        {
                            if (string.Equals(row.TeacherStatus, "Approved", StringComparison.OrdinalIgnoreCase))
                            {
                                <form method="post" asp-area="Admin" asp-controller="ManageUsers" asp-action="UnapproveTeacher" class="m-0 d-inline-block">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@row.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-warning flex-shrink-0">@L["Admin.Unapprove"]</button>
                                </form>
                            }
                            else
                            {
                                <form method="post" asp-area="Admin" asp-controller="ManageUsers" asp-action="ApproveTeacher" class="m-0 d-inline-block">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@row.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-success flex-shrink-0">@L["Button.Approve"]</button>
                                </form>
                            }
                        }

                        @if (row.IsAllowed.HasValue)
                        {
                            <form method="post"
                                  asp-area="Admin"
                                  asp-controller="ManageUsers"
                                  asp-action="ToggleStudentAllowedAjax"
                                  class="student-allow-form m-0 d-inline-block"
                                  data-user-id="@row.Id">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@row.Id" />
                                <input type="hidden" name="setTo" value="@(row.IsAllowed.Value ? "false" : "true")" class="setToInput" />
                                <button type="submit"
                                        class="btn btn-sm student-allow-btn @(row.IsAllowed.Value ? "btn-success" : "btn-outline-secondary") flex-shrink-0">
                                    @(row.IsAllowed.Value? L["Admin.Allowed"] : L["Admin.NotAllowed"])
                                </button>
                            </form>
                        }

                        @{
                            var isTargetAdmin = (row.Roles ?? "")
                            .Split(',', StringSplitOptions.RemoveEmptyEntries)
                            .Select(r => r.Trim())
                            .Any(r => string.Equals(r, "Admin", StringComparison.OrdinalIgnoreCase));
                        }

                        @* Soft-delete / Restore: hide for Admin users *@
                        @if (!isTargetAdmin)
                        {
                            <form method="post" asp-area="Admin" asp-controller="ManageUsers" asp-action="SoftDelete" class="m-0 d-inline-block">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@row.Id" />
                                <button type="submit" class="btn btn-sm btn-outline-danger flex-shrink-0">
                                    @(Model.ShowDeleted? L["Admin.Restore"] : L["Admin.Suspend"])
                                </button>
                            </form>
                        }

                        @if (Model.ShowDeleted && !isTargetAdmin)
                        {
                            <form method="post" asp-area="Admin" asp-controller="ManageUsers" asp-action="HardDelete" class="m-0 d-inline-block">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@row.Id" />
                                <button type="submit" class="btn btn-sm btn-danger flex-shrink-0">@L["Admin.DeletePermanently"]</button>
                            </form>
                        }
                    </div>

                    </div>
                }
            }
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center justify-content-md-end">
                <li class="page-item @(Model.Items?.HasPreviousPage == true ? "" : "disabled")">
                    <a class="page-link" href="@Url.Action("Index", new { role = Model.CurrentRoleFilter, showDeleted = Model.ShowDeleted, search = Model.Search, pageIndex = Model.PageIndex - 1, pageSize = Model.PageSize })" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>

                @for (int p = 1; p <= (Model.Items?.TotalPages ?? 1); p++)
                {
                    <li class="page-item @(p == Model.PageIndex ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { role = Model.CurrentRoleFilter, showDeleted = Model.ShowDeleted, search = Model.Search, pageIndex = p, pageSize = Model.PageSize })">@p</a>
                    </li>
                }

                <li class="page-item @(Model.Items?.HasNextPage == true ? "" : "disabled")">
                    <a class="page-link" href="@Url.Action("Index", new { role = Model.CurrentRoleFilter, showDeleted = Model.ShowDeleted, search = Model.Search, pageIndex = Model.PageIndex + 1, pageSize = Model.PageSize })" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>

    </div>
</div>

@section Scripts {
    <script>
        // Auto-dismiss server TempData alerts (if any)
        (function () {
            var dismissMs = 10000;
            setTimeout(function () {
                document.querySelectorAll('.admin-temp-alert').forEach(function (el) {
                    try { if (window.bootstrap && bootstrap.Alert) bootstrap.Alert.getOrCreateInstance(el).close(); else el.remove(); } catch (e) { el.remove(); }
                });
            }, dismissMs);
        })();
    </script>

    <script>
        // Localized strings for AJAX toggle
        var txtAllowed = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.Allowed"].Value ?? "Allowed"));
        var txtNotAllowed = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.NotAllowed"].Value ?? "Not allowed"));
        var txtAllowAccess = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.AllowAccess"].Value ?? "Allow access"));
        var txtRevokeAccess = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.RevokeAccess"].Value ?? "Revoke access"));
        var txtToggleFailed = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.ToggleFailed"].Value ?? "Failed to update access. Please try again."));

        (function ($) {
            function showTempAlert(message, type = 'success', timeout = 4000) {
                const $alert = $('<div class="alert alert-' + type + ' admin-temp-alert" role="alert" style="position:fixed;top:20px;right:20px;z-index:1055;min-width:220px;">' + message + '</div>');
                $('body').append($alert);
                setTimeout(function () { $alert.fadeOut(300, function () { $(this).remove(); }); }, timeout);
            }

            // AJAX handler for student-allow toggle forms
            $(document).on('submit', '.student-allow-form', function (e) {
                e.preventDefault();
                var $form = $(this);
                var action = $form.attr('action') || window.location.href;
                var id = $form.find('input[name="id"]').val();
                var setTo = $form.find('input[name="setTo"]').val();
                var token = $form.find('input[name="__RequestVerificationToken"]').val();
                var $btn = $form.find('.student-allow-btn');
                $btn.prop('disabled', true);

                $.ajax({
                    url: action,
                    method: 'POST',
                    data: { id: id, setTo: setTo },
                    headers: { 'RequestVerificationToken': token },
                    success: function (resp) {
                        if (resp && resp.success) {
                            var newSetTo = (setTo === 'true' || setTo === 'True') ? 'false' : 'true';
                            $form.find('input.setToInput').val(newSetTo);

                            var isAllowed = resp.isAllowed === true || resp.isAllowed === 'true';
                            if (isAllowed) {
                                $btn.removeClass('btn-outline-secondary').addClass('btn-success');
                                $btn.find('i').removeClass('fa-user-lock').addClass('fa-check-circle');
                                $btn.attr('title', txtRevokeAccess);
                                if ($btn.find('span').length) $btn.find('span').text(txtAllowed);
                            } else {
                                $btn.removeClass('btn-success').addClass('btn-outline-secondary');
                                $btn.find('i').removeClass('fa-check-circle').addClass('fa-user-lock');
                                $btn.attr('title', txtAllowAccess);
                                if ($btn.find('span').length) $btn.find('span').text(txtNotAllowed);
                            }

                            showTempAlert(resp.message || txtAllowed, 'success', 2500);
                        } else {
                            showTempAlert((resp && resp.message) ? resp.message : txtToggleFailed, 'danger', 4000);
                        }
                    },
                    error: function (xhr) {
                        var msg = txtToggleFailed;
                        try {
                            var json = xhr.responseJSON;
                            if (json && json.message) msg = json.message;
                        } catch (e) { }
                        showTempAlert(msg, 'danger', 5000);
                    },
                    complete: function () {
                        $btn.prop('disabled', false);
                    }
                });
            });
        })(jQuery);
    </script>
}










