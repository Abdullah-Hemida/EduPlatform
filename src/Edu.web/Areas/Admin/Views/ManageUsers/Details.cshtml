@model Edu.Web.Areas.Admin.ViewModels.UserDetailsViewModel
@using Edu.Infrastructure.Helpers
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

@{
    ViewData["Title"] = L["Admin.UserDetails"];
}

<div class="row">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <img src="@(!string.IsNullOrEmpty(Model.PhotoUrl) ? Model.PhotoUrl : Url.Content("~/uploads/images/default-avatar.png"))"
                     class="rounded-circle mb-3" style="width:140px;height:140px;object-fit:cover;" alt="@Model.FullName" />
                <h4 class="mb-0">@Model.FullName</h4>
                <p class="text-muted mb-1">@string.Join(", ", Model.Roles)</p>
                <p class="mb-0"><strong>@L["Admin.Email"]:</strong><br />@Model.Email</p>
                <p><strong>@L["Profile.DateOfBirth"]</strong> @Model.DateOfBirth?.ToString("yyyy-MM-dd")</p>
                <p class="mb-0"><strong>@L["Admin.Phone"]:</strong><br />@Model.PhoneNumber</p>
            </div>
        </div>

        <div class="mt-3">
            <a class="btn btn-outline-primary w-100" href="@Url.Action("Index", "ManageUsers", new { area = "Admin" })">@L["Admin.BackToList"]</a>
        </div>
    </div>

    <div class="col-md-8">
        @if (Model.Teacher != null)
        {
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>@L["Admin.TeacherInfo"]</strong>
                    <div>
                        @if (Model.Teacher.Status != TeacherStatus.Approved)
                        {
                            <button class="btn btn-sm btn-success js-approve-teacher" data-id="@Model.Id">@L["Admin.ApproveTeacher"]</button>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-warning js-unapprove-teacher" data-id="@Model.Id">@L["Admin.UnapproveTeacher"]</button>
                        }
                    </div>
                </div>

                <div class="card-body">
                    <p><strong>@L["Profile.JobTitleLabel"]</strong> @Model.Teacher.JobTitle</p>
                    <p><strong>@L["Profile.ShortBioLabel"]</strong><br />@(string.IsNullOrEmpty(Model.Teacher.ShortBio) ? L["Profile.NoBio"] : Model.Teacher.ShortBio)</p>

                    <p>
                        <strong>@L["Profile.CVLabel"]</strong>:
                        @if (!string.IsNullOrEmpty(Model.Teacher.CVUrl))
                        {
                            <a asp-action="DownloadCV" asp-route-id="@Model.Id" class="btn btn-sm btn-outline-primary ms-2">@L["Profile.DownloadCV"]</a>
                        }
                        else
                        {
                            <span class="text-muted">@L["Profile.NoCV"]</span>
                        }
                    </p>

                    <div class="mt-3">
                        <strong>@L["Profile.IntroVideoLabel"]</strong>
                        @if (!string.IsNullOrEmpty(Model.Teacher.IntroVideoUrl))
                        {
                            var ytId = YouTubeHelper.ExtractYouTubeId(Model.Teacher.IntroVideoUrl);
                            if (!string.IsNullOrEmpty(ytId))
                            {
                                <div class="ratio ratio-16x9 mt-2">
                                    <iframe src="https://www.youtube-nocookie.com/embed/@ytId" title="@L["Profile.IntroVideoLabel"]" allowfullscreen></iframe>
                                </div>
                            }
                            else
                            {
                                <p class="text-muted">@L["Profile.IntroVideoInvalid"]</p>
                            }
                        }
                        else
                        {
                            <p class="text-muted">@L["Profile.NoIntroVideo"]</p>
                        }
                    </div>
                </div>
            </div>
        }

        <div class="card mb-3">
            <div class="card-header"><strong>@L["Admin.StudentInfo"]</strong></div>
            <div class="card-body">
                @if (Model.Student == null)
                {
                    <div class="alert alert-warning">
                        @(L["Admin.NoStudentRecord", ""] ?? "This user has no Student record. Saving curricula will create one.")
                    </div>
                }
                <p>
                    <strong>@L["Admin.StudentAllowed"]:</strong>
                    @if (Model.StudentIsAllowed == true)
                    {
                        <span class="badge bg-success ms-2">@L["Admin.Allowed"]</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary ms-2">@L["Admin.NotAllowed"]</span>
                    }
                </p>
                <div>@L["GuardianPhoneNumber"] : @Model.GuardianPhoneNumber</div>
                <form asp-action="AssignCurricula" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />

                    <div class="mb-2">
                        <strong>@L["Admin.StudentCurricula"]</strong>
                        <p class="small text-muted">@L["Admin.StudentCurriculaHint"]</p>
                    </div>

                    @if (Model.Curricula == null || !Model.Curricula.Any())
                    {
                        <p class="text-muted">@L["Admin.NoCurricula"]</p>
                    }
                    else
                    {
                        foreach (var c in Model.Curricula)
                        {
                            var isChecked = Model.SelectedCurriculumIds != null && Model.SelectedCurriculumIds.Contains(c.Id);
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       name="selectedCurriculumIds" value="@c.Id" id="cur_@c.Id" @(isChecked ? "checked" : "") />
                                <label class="form-check-label" for="cur_@c.Id">
                                    @c.Title
                                    @if (!string.IsNullOrEmpty(c.LevelName))
                                    {
                                        <small class="text-muted"> (@c.LevelName)</small>
                                    }
                                </label>
                            </div>
                        }
                    }

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">@L["Admin.Save"]</button>
                        <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary ms-2">@L["Admin.Cancel"]</a>
                    </div>
                </form>
            </div>
        </div>

        <div id="ajaxMsgs"></div>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin-users.js"></script>
}




