@model Edu.Web.Areas.Admin.ViewModels.AdminBookingDetailsVm
@using Edu.Domain.Entities
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

@{
    ViewData["Title"] = L["Admin.BookingDetails"] ?? "Booking details";
}

<form id="antiForgeryForm">@Html.AntiForgeryToken()</form>

<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <h4 class="mb-0">@L["Booking.Title"]</h4>
        <div class="small text-muted">#@Model.Id</div>
    </div>
    <div class="">
        <a asp-action="Index" class="btn btn-secondary btn-sm ps-3 pe-3">
            <i class="fas fa-arrow-left me-1 d-none d-rtl-none"></i>
            <i class="fas fa-arrow-right ms-1 d-none d-ltr-none"></i>
            @L["Common.Back"]</a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <h6 class="text-muted">@L["Booking.Student"]</h6>
                        <div class="fw-semibold">@(Model.StudentName ?? "—")</div>
                        <div class="small text-muted">@(Model.StudentEmail ?? "—")</div>

                        <div class="small text-muted d-flex align-items-center gap-2">
                            <span dir="ltr" class="ltr-phone">@(Model.StudentPhoneNumber ?? "—")</span>
                            <span dir="ltr">
                                @await Html.PartialAsync("_WhatsAppChatButton", Model.StudentWhatsapp)
                            </span>
                        </div>

                        <div class="mt-2 small text-muted d-flex align-items-center gap-2">
                            <strong>@L["GuardianPhoneNumber"]:</strong>
                            <span dir="ltr" class="ltr-phone">@((Model.GuardianPhoneNumber) ?? "—")</span>
                            <span dir="ltr">
                                @await Html.PartialAsync("_WhatsAppChatButton", Model.GuardianWhatsapp)
                            </span>
                        </div>
                    </div>


                    <div class="col-md-6">
                        <h6 class="text-muted">@L["Booking.Teacher"]</h6>
                        <div class="fw-semibold">@(Model.TeacherName ?? "—")</div>
                    </div>

                    <div class="col-md-6">
                        <h6 class="text-muted">@L["Booking.RequestDate"]</h6>
                        <div class="fw-semibold">@Model.RequestedDateUtc.ToLocalTime().ToString("g")</div>
                    </div>

                    <div class="col-md-6">
                        <h6 class="text-muted">@L["Booking.Status"]</h6>
                        <div>
                            <span class="badge booking-status-badge @(Model.Status == BookingStatus.Paid ? "bg-primary" : "bg-secondary")">@Model.Status</span>
                        </div>
                    </div>

                    <div class="col-12">
                        <h6 class="text-muted">@L["Booking.Notes"]</h6>
                        <div class="small text-muted">@(!string.IsNullOrEmpty(Model.Notes) ? Model.Notes : L["Admin.NoNotes"])</div>
                    </div>

                    <div class="col-12">
                        <h6 class="text-muted">@L["Booking.Meet"]</h6>
                        @if (!string.IsNullOrEmpty(Model.MeetUrl))
                        {
                            <div><a class="btn btn-outline-primary btn-sm" href="@Model.MeetUrl" target="_blank">@L["OpenMeet"]</a></div>
                        }
                        else
                        {
                            <div class="small text-muted">@L["Booking.NoMeetUrl"]</div>
                        }
                    </div>
                </div>
            </div>
        </div>

    </div>

    <aside class="col-lg-4">
        <div class="card mb-3">
            <div class="card-body d-grid gap-2">
                @if (Model.Status != BookingStatus.Paid)
                {
                    <button id="markPaidBtn" data-id="@Model.Id" class="btn btn-outline-primary">@L["Booking.MarkPaid"]</button>
                }
                else
                {
                    <button class="btn btn-success" disabled>@L["Admin.Paid"]</button>
                }
                <a asp-action="Index" class="btn btn-light">@L["Button.Close"]</a>
            </div>
        </div>
    </aside>

</div>

@section Scripts {
    <script>
        (function ($) {
            var texts = {
                confirmMarkPaid: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Booking.ConfirmMarkPaid"].Value ?? "Mark this booking as paid?")),
                promptAmount: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Booking.PromptAmount"].Value ?? "Optional: enter amount (leave empty to keep current)")),
                promptPaymentRef: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Booking.PromptPaymentRef"].Value ?? "Optional: payment reference / note:")),
                operationFailed: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.OperationFailed"].Value ?? "Operation failed")),
                serverError: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.ServerError"].Value ?? "Server error, try again.")),
                paidLabel: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Booking.MarkedPaidLabel"].Value ?? "Paid")),
                bookingStatusPaid: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Booking.Status.Paid"].Value ?? "Paid"))
            };

            function getAntiForgeryToken() {
                return $('#antiForgeryForm input[name="__RequestVerificationToken"]').val() || '';
            }

            $(function () {
                var $markBtn = $('#markPaidBtn');
                if (!$markBtn || !$markBtn.length) return;

                $markBtn.on('click', function (e) {
                    e.preventDefault();
                    var id = parseInt($(this).data('id'), 10);
                    if (!id) return;

                    if (!confirm(texts.confirmMarkPaid)) return;

                    var amountRaw = prompt(texts.promptAmount + ":");
                    var amount = null;
                    if (amountRaw !== null && amountRaw.trim() !== '') {
                        var parsed = parseFloat(amountRaw.replace(',', '.'));
                        if (!isNaN(parsed)) amount = parsed;
                        else {
                            alert(texts.operationFailed);
                        }
                    }

                    var paymentRef = prompt(texts.promptPaymentRef);

                    var payload = { Id: id, Amount: amount, PaymentRef: paymentRef };

                    $markBtn.prop('disabled', true).addClass('disabled');

                    $.ajax({
                        url: '@Url.Action("MarkPaid", "Bookings", new { area = "Admin" })',
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(payload),
                        headers: {
                            'RequestVerificationToken': getAntiForgeryToken()
                        }
                    }).done(function (data) {
                        if (data && data.success) {
                            // update badge(s) on page
                            var $badge = $('.booking-status-badge');
                            if ($badge && $badge.length) {
                                $badge.removeClass().addClass('booking-status-badge badge bg-success');
                                $badge.text(texts.bookingStatusPaid);
                            }

                            // change button to success state
                            $markBtn.removeClass('btn-outline-primary').addClass('btn-success').text(texts.paidLabel).prop('disabled', true);
                        } else {
                            alert(data && data.error ? data.error : texts.operationFailed);
                            $markBtn.prop('disabled', false).removeClass('disabled');
                        }
                    }).fail(function () {
                        alert(texts.serverError);
                        $markBtn.prop('disabled', false).removeClass('disabled');
                    });
                });
            });
        })(jQuery);
    </script>
}



