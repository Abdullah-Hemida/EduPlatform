@model Edu.Web.Areas.Admin.ViewModels.EarningsIndexVm
@using System.Globalization
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

@{
    Layout = "/Views/Shared/_DashboardLayout.cshtml";
    ViewData["Title"] = L["Admin.Earnings"] ?? "Earnings";

    var selectedYear = Model.Year == 0 ? DateTime.UtcNow.Year : Model.Year;
    var current = DateTime.UtcNow.Year;
    var monthNames = Enumerable.Range(1, 12)
                    .Select(m => CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m))
                    .ToArray();
}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-3">
    <div>
        <h4 class="mb-0">@L["Admin.Earnings"]</h4>
        <div class="small text-muted">@L["Admin.Overview"]</div>
    </div>

    <form class="d-flex gap-2 align-items-center" method="get" asp-action="Index" asp-area="Admin" id="yearForm">
        <label for="yearSelect" class="visually-hidden">@L["Admin.Year"]</label>
        <select id="yearSelect" name="year" class="form-select form-select-sm" onchange="document.getElementById('yearForm').submit()">
            @for (int y = current; y >= current - 5; y--)
            {
                if (y == selectedYear)
                {
                    <option value="@y" selected>@y</option>
                }
                else
                {
                    <option value="@y">@y</option>
                }
            }
        </select>

        <button type="submit" class="btn btn-primary btn-sm">
            <i class="fas fa-search me-1" aria-hidden="true"></i> @L["Button.Search"]
        </button>
    </form>
</div>

<!-- TABLE: tablet+ / desktop with responsive month columns (table-sm + less padding) -->
<div class="card mb-3 d-none d-md-block">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width:44px" class="py-2">#</th>
                        <th style="min-width:160px" class="py-2">@L["Admin.FullName"]</th>

                        @for (int i = 0; i < 12; i++)
                        {
                            string thClass = i < 3
                                ? ""                              // months 1-3: always show
                                : i < 6
                                    ? "d-none d-md-table-cell"   // months 4-6: md+
                                    : i < 9
                                        ? "d-none d-lg-table-cell" // months 7-9: lg+
                                        : "d-none d-xl-table-cell"; // months 10-12: xl+
                            <th class="text-end text-nowrap small @thClass py-2">@monthNames[i]</th>
                        }

                        <th class="text-end text-nowrap small py-2">@L["Admin.Total"]</th>
                    </tr>
                </thead>

                <tbody>
                    @if (Model.Teachers == null || !Model.Teachers.Any())
                    {
                        <tr>
                            <td colspan="16" class="text-center text-muted py-4">@L["Admin.NoRecords"]</td>
                        </tr>
                    }
                    else
                    {
                        var idx = 1;
                        foreach (var t in Model.Teachers)
                        {
                            <tr>
                                <td class="align-middle py-2">@idx</td>

                                <td class="align-middle py-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <img src="@(!string.IsNullOrEmpty(t.PhotoUrl) ? t.PhotoUrl : Url.Content("~/uploads/images/default-avatar.jpg"))"
                                             alt="@t.FullName"
                                             class="rounded"
                                             loading="lazy"
                                             style="width:40px; height:40px; object-fit:cover;" />
                                        <div class="d-flex flex-column min-w-0">
                                            <span class="fw-semibold text-truncate small">@t.FullName</span>
                                            <small class="text-muted text-truncate">@(!string.IsNullOrEmpty(t.PhoneNumber) ? t.PhoneNumber : "-")</small>
                                        </div>
                                    </div>
                                </td>

                                @for (int i = 0; i < 12; i++)
                                {
                                    var amount = (t.Months != null && t.Months.Length > i) ? t.Months[i] : 0m;
                                    string tdClass = i < 3
                                        ? "" 
                                        : i < 6
                                            ? "d-none d-md-table-cell"
                                            : i < 9
                                                ? "d-none d-lg-table-cell"
                                                : "d-none d-xl-table-cell";
                                    <td class="text-end align-middle small @tdClass py-2">@t.FormatMoney(amount)</td>
                                }

                                <td class="text-end fw-semibold align-middle small py-2">@t.FormatMoney(t.Total)</td>
                            </tr>
                            idx++;
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MOBILE: stacked cards with toggle (Recent 3 months | All months grid 3-per-row) -->
<div class="d-block d-md-none">
    @if (Model.Teachers == null || !Model.Teachers.Any())
    {
        <div class="text-center text-muted py-4">@L["Admin.NoRecords"]</div>
    }
    else
    {
        <!-- Toggle controls -->
        <div class="mb-3 d-flex justify-content-end">
            <div class="btn-group btn-group-sm" role="group" aria-label="Month view toggle">
                <button type="button" class="btn btn-outline-secondary active" id="recent3Btn" aria-pressed="true">@L["Admin.RecentMonths"]</button>
                <button type="button" class="btn btn-outline-secondary" id="allMonthsBtn" aria-pressed="false">@L["Admin.AllMonths"]</button>
            </div>
        </div>

        <div class="row g-3">
            @foreach (var t in Model.Teachers)
            {
                <div class="col-12">
                    <div class="card">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-start gap-2">
                                <img src="@(!string.IsNullOrEmpty(t.PhotoUrl) ? t.PhotoUrl : Url.Content("~/uploads/images/default-avatar.jpg"))"
                                     alt="@t.FullName"
                                     class="rounded"
                                     loading="lazy"
                                     style="width:56px; height:56px; object-fit:cover;" />
                                <div class="flex-grow-1 min-w-0">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="min-w-0">
                                            <div class="fw-semibold text-truncate">@t.FullName</div>
                                            <div class="small text-muted text-truncate">@(!string.IsNullOrEmpty(t.PhoneNumber) ? t.PhoneNumber : "-")</div>
                                        </div>

                                        <div class="text-end ms-2">
                                            <div class="small text-muted">@L["Admin.Total"]</div>
                                            <div class="fw-semibold">@t.FormatMoney(t.Total)</div>
                                        </div>
                                    </div>

                                    <!-- RECENT 3 (default) -->
                                    <div class="mt-2 recent-3-container">
                                        <div class="small text-muted mb-1">@L["Admin.RecentMonths"]</div>
                                        <div class="d-flex gap-2 overflow-auto">
                                            @{
                                                int start = Math.Max(0, 12 - 3);
                                                for (int i = start; i < 12; i++)
                                                {
                                                    var monthLabel = monthNames[i];
                                                    var amount = (t.Months != null && t.Months.Length > i) ? t.Months[i] : 0m;
                                                    <div class="flex-shrink-0 p-1 bg-light rounded text-end" style="min-width:72px;">
                                                        <div class="small text-muted">@monthLabel</div>
                                                        <div class="fw-semibold small">@t.FormatMoney(amount)</div>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>

                                    <!-- ALL 12 months grid (hidden by default) -->
                                    <div class="mt-2 all-months-container d-none">
                                        <div class="small text-muted mb-2">@L["Admin.AllMonths"]</div>

                                        <div class="row g-2">
                                            @for (int i = 0; i < 12; i += 3)
                                            {
                                                <div class="col-12">
                                                    <div class="row g-2">
                                                        @for (int j = i; j < i + 3 && j < 12; j++)
                                                        {
                                                            var monthLabel = monthNames[j];
                                                            var amount = (t.Months != null && t.Months.Length > j) ? t.Months[j] : 0m;
                                                            <div class="col-4">
                                                                <div class="p-1 bg-light rounded text-end">
                                                                    <div class="small text-muted">@monthLabel</div>
                                                                    <div class="fw-semibold small">@t.FormatMoney(amount)</div>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <!-- end all-months-container -->

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        (function () {
            // Toggle recent / all months on mobile
            var recentBtn = document.getElementById('recent3Btn');
            var allBtn = document.getElementById('allMonthsBtn');

            function setActiveMode(mode) {
                var recentElems = document.querySelectorAll('.recent-3-container');
                var allElems = document.querySelectorAll('.all-months-container');

                if (mode === 'recent') {
                    recentElems.forEach(e => e.classList.remove('d-none'));
                    allElems.forEach(e => e.classList.add('d-none'));
                    recentBtn.classList.add('active');
                    allBtn.classList.remove('active');
                    recentBtn.setAttribute('aria-pressed', 'true');
                    allBtn.setAttribute('aria-pressed', 'false');
                } else {
                    recentElems.forEach(e => e.classList.add('d-none'));
                    allElems.forEach(e => e.classList.remove('d-none'));
                    recentBtn.classList.remove('active');
                    allBtn.classList.add('active');
                    recentBtn.setAttribute('aria-pressed', 'false');
                    allBtn.setAttribute('aria-pressed', 'true');
                }
            }

            if (recentBtn && allBtn) {
                recentBtn.addEventListener('click', function () { setActiveMode('recent'); });
                allBtn.addEventListener('click', function () { setActiveMode('all'); });
                // default mode
                setActiveMode('recent');
            }

            // keyboard friendly month scrolls
            document.querySelectorAll('.d-flex.overflow-auto').forEach(function (el) {
                el.setAttribute('tabindex', '0');
                el.addEventListener('keydown', function (e) {
                    if (e.key === 'ArrowLeft') { el.scrollBy({ left: -100, behavior: 'smooth' }); }
                    if (e.key === 'ArrowRight') { el.scrollBy({ left: 100, behavior: 'smooth' }); }
                });
            });
        })();
    </script>
}







