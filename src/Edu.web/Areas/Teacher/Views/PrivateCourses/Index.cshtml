@model Edu.Web.Areas.Teacher.ViewModels.TeacherCourseIndexVm
@using Microsoft.AspNetCore.Mvc.Rendering
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

@{
    ViewData["Title"] = L["Nav.TeacherDashboard"] ?? "My Courses";

    // category items prepared by controller (localized & ordered)
    var catItems = ViewBag.CategorySelect as IEnumerable<SelectListItem> ?? Enumerable.Empty<SelectListItem>();

    // preserve current values from model or querystring
    string currentQ = Model.Query ?? (Context.Request.Query.ContainsKey("q") ? Context.Request.Query["q"].ToString() : "");
    string currentCategory = (Model.CategoryId.HasValue ? Model.CategoryId.Value.ToString() : (Context.Request.Query.ContainsKey("categoryId") ? Context.Request.Query["categoryId"].ToString() : ""));
    string currentShowPublished = (Model.ShowPublished.HasValue ? (Model.ShowPublished.Value ? "true" : "false") : (Context.Request.Query.ContainsKey("showPublished") ? Context.Request.Query["showPublished"].ToString() : ""));
    string crop(string? s, int len = 140) => string.IsNullOrEmpty(s) ? "" : (s.Length <= len ? s : s.Substring(0, len) + "…");
}

<div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2 mb-3 mt-3">
    <div>
        <h4 class="mb-0">@L["Teacher.RecordedCourses"]</h4>
        <div class="small text-muted">@L["Nav.RecordedCourses"]</div>
    </div>

    <form method="get" class="d-flex gap-2 align-items-center" id="teacherCoursesFilters" role="search" aria-label="@L["Filters"]">
        <!-- Keep q so other filters don't lose it when category auto-submits -->
        <input type="hidden" name="q" value="@currentQ" />

        <!-- Category select: All first, then categories from controller -->
        <div>
            <label class="visually-hidden" for="categorySelect">@L["Admin.Category"]</label>
            <select id="categorySelect" name="categoryId" class="form-select form-select-sm" onchange="this.form.submit()" aria-label="@L["Admin.Category"]">
                <option value="" selected="@(string.IsNullOrEmpty(currentCategory) ? "selected" : null)">@L["Common.All"]</option>
                @foreach (var s in catItems)
                {
                    var value = s.Value ?? "";
                    var text = s.Text ?? value;
                    <option value="@value" selected="@(value == currentCategory ? "selected" : null)">@text</option>
                }
            </select>
        </div>

        <!-- Published filter (optional; controller may or may not provide) -->
        <div>
            <label class="visually-hidden" for="publishedSelect">@L["Admin.Published"]</label>
            @if (ViewBag.ShowPublishedSelect is IEnumerable<SelectListItem> pubItems && pubItems.Any())
            {
                <select id="publishedSelect" name="showPublished" class="form-select form-select-sm" aria-label="@L["Admin.Published"]">
                    <option value="" selected="@(string.IsNullOrEmpty(currentShowPublished) ? "selected" : null)">@L["Common.All"]</option>
                    @foreach (var pi in pubItems)
                    {
                        var v = pi.Value ?? "";
                        <option value="@v" selected="@(v == currentShowPublished ? "selected" : null)">@pi.Text</option>
                    }
                </select>
            }
        </div>

        <!-- Search field (visible in wider viewports) -->
        <div class="d-none d-md-block">
            <input name="q" value="@currentQ" class="form-control form-control-sm" placeholder="@L["Admin.SearchPlaceholder"]" aria-label="@L["DataTable.Search"]" />
        </div>

        <div>
            <button type="submit" class="btn btn-primary btn-sm">@L["Button.Search"]</button>
        </div>
    </form>
</div>

@if (Model.Courses == null || !Model.Courses.Any())
{
    <div class="text-muted text-center py-4">@L["Admin.NoRecords"]</div>
}
else
{
    <div class="row g-3">
        @foreach (var c in Model.Courses)
        {
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm course-card">
                    @if (!string.IsNullOrEmpty(c.PublicCoverUrl))
                    {
                        <div class="position-relative">
                            <img src="@c.PublicCoverUrl" class="card-img-top" style="height:140px;object-fit:cover" alt="@c.Title" />
                            @if (c.IsPublished)
                            {
                                <span class="badge bg-success position-absolute top-0 start-0 m-2 px-2 py-1 fs-7">@(L["Admin.PublishedShort"] ?? "Published")</span>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="bg-light border rounded text-center" style="height:140px;display:flex;align-items:center;justify-content:center">
                            <span class="small text-muted">@L["Admin.NoVideo"]</span>
                        </div>
                    }

                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@c.Title</h5>

                        <div class="meta mb-2">
                            <span class="me-2">@c.CategoryName</span>
                        </div>

                        <div class="mt-auto">
                            <div class="d-flex align-items-center justify-content-between gap-2">
                                <div class="fw-semibold">@c.PriceLabel</div>

                                <a class="btn btn-outline-primary btn-sm" asp-action="Details" asp-route-id="@c.Id">@L["Button.View"]</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @* Pagination: preserve all current filters in the URL *@
    
        Func<int, object> pageRoute = p => new
        {
            q = currentQ,
            categoryId = string.IsNullOrEmpty(currentCategory) ? (int?)null : int.Parse(currentCategory),
            showPublished = string.IsNullOrEmpty(currentShowPublished) ? null : currentShowPublished,
            page = p
        };
 
    <nav class="mt-4" aria-label="Page navigation">
        <ul class="pagination justify-content-center mb-0">
            <li class="page-item @(Model.Courses.HasPreviousPage ? "" : "disabled")">
                <a class="page-link" href="@Url.Action("Index", pageRoute(Model.Courses.PageIndex - 1))" aria-label="Previous">&laquo;</a>
            </li>

            @for (int i = 1; i <= Model.Courses.TotalPages; i++)
            {
                <li class="page-item @(Model.Courses.PageIndex == i ? "active" : "")">
                    <a class="page-link" href="@Url.Action("Index", pageRoute(i))">@i</a>
                </li>
            }

            <li class="page-item @(Model.Courses.HasNextPage ? "" : "disabled")">
                <a class="page-link" href="@Url.Action("Index", pageRoute(Model.Courses.PageIndex + 1))" aria-label="Next">&raquo;</a>
            </li>
        </ul>
    </nav>
}

@section Scripts {
    <script>
        (function () {
            var form = document.getElementById('teacherCoursesFilters');
            if (!form) return;
            var timeout;
            Array.from(form.querySelectorAll('select')).forEach(function (s) {
                s.addEventListener('change', function () {
                    clearTimeout(timeout);
                    timeout = setTimeout(function () { form.submit(); }, 120);
                });
            });
        })();
    </script>
}



