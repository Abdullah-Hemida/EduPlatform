@model Edu.Web.Areas.Teacher.ViewModels.ReactiveCourseDetailsVm
@using Edu.Infrastructure.Helpers
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

@{
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
    ViewData["Title"] = Model.Title;
}

<div id="alert-container" class="mb-3"></div>

<div class="d-flex align-items-center mb-3 justify-content-between">
    <div>
        <h3 class="mb-0">@Model.Title</h3>
        <div class="small text-muted">@Model.Description</div>
    </div>

    <a asp-area="Teacher"
       asp-controller="ReactiveCourses"
       asp-action="Index"
       class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1">
        <span class="d-inline ltr-only"></span>
        <span class="d-inline rtl-only"></span>
        <span>@L["Common.Back"]</span>
    </a>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card mb-3">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="small text-muted">@L["ReactiveCourse.PricePerMonth"]</div>
                    <div class="h5">@Model.PricePerMonthLabel</div>
                </div>
                <div class="text-end">
                    <div class="small text-muted">@L["ReactiveCourse.Duration"]</div>
                    <div class="fw-semibold">@Model.DurationMonths @L["ReactiveCourse.Months"]</div>
                </div>
            </div>
        </div>

        @foreach (var month in Model.Months)
        {
            <div class="card mb-3">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <strong>@L["ReactiveCourse.Month"] @month.MonthIndex</strong>
                        <div class="small text-muted">@month.LessonsCount @L["Course.Lessons"]</div>
                    </div>

                    <div class="d-flex gap-2 align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-primary js-add-lesson"
                                data-monthid="@month.Id"
                                data-courseid="@Model.Id">
                            @L["ReactiveCourse.AddLesson"]
                        </button>

                        <form asp-area="Teacher"
                              asp-controller="ReactiveCourses"
                              asp-action="SetMonthReady"
                              method="post"
                              class="d-inline js-set-month-ready-form"
                              data-monthid="@month.Id">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="monthId" value="@month.Id" />
                            <input type="hidden" name="ready" value="@(!month.IsReadyForPayment ? "true" : "false")" />

                            <button type="button"
                                    class="btn btn-sm js-toggle-month-ready @(month.IsReadyForPayment ? "btn-success" : "btn-outline-secondary")"
                                    data-monthid="@month.Id"
                                    data-isready="@(month.IsReadyForPayment ? "true" : "false")"
                                    aria-pressed="@(month.IsReadyForPayment ? "true" : "false")">
                                @(month.IsReadyForPayment? L["ReactiveCourse.MonthReady"] : L["ReactiveCourse.MarkReady"])
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card-body">

                    @if (!month.Lessons.Any())
                    {
                        <div class="text-muted small">@(L["Admin.NoRecords"] ?? "No records.")</div>
                    }
                    else
                    {
                        <div class="list-group list-group-flush">
                            @foreach(var lesson in month.Lessons)
                            {
                                var ytId = YouTubeHelper.ExtractYouTubeId(lesson.RecordedVideoUrl);
                                var embedUrl = !string.IsNullOrEmpty(ytId)
                                ? $"https://www.youtube-nocookie.com/embed/{ytId}?rel=0"
                                : null;

                                <div class="list-group-item ps-0 pe-0 py-3" data-lesson-id="@lesson.Id">
                                    <div class="row gx-3 gy-2 align-items-start">
                                        <div class="col-md-7">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div style="min-width:0">
                                                    <div class="fw-semibold text-truncate">@lesson.Title</div>
                                                    <div class="small text-muted">
                                                        @(lesson.ScheduledUtc.HasValue
                                                                                                    ? lesson.ScheduledUtc.Value.ToLocalTime().ToString("g")
                                                                                                    : (L["ReactiveCourse.NoSchedule"] ?? "No schedule."))
                                        </div>
                                        @if (!string.IsNullOrEmpty(lesson.Notes))
                                                    {
                                                        <div class="small mt-1 text-muted">@lesson.Notes</div>
                                                    }

                                                    @* Attachments (if any) *@
                                                    @if (lesson.Files != null && lesson.Files.Any())
                                                    {
                                                        <div class="mt-2">
                                                            <strong class="small">@L["Attachments"]</strong>
                                                            <ul class="small list-unstyled mt-1 mb-0">
                                                                @foreach (var a in lesson.Files)
                                                                {
                                                                    <li id="file-@a.Id" class="d-flex align-items-center mb-1">
                                                                        <a href="@(a.PublicUrl ?? a.DownloadUrl)"
                                                                           class="js-file-download me-2 small text-truncate flex-grow-1"
                                                                           data-file-id="@a.Id"
                                                                           data-public-url="@(a.PublicUrl ?? string.Empty)"
                                                                           target="_blank" rel="noopener noreferrer" style="max-width:100%;">
                                                                            @a.FileName
                                                                        </a>

                                                                        <span class="text-muted small ms-2">(@(a.FileType ?? ""))</span>

                                                                        @* Delete button for owner/admin - uses AJAX DeleteAjax in Admin area *@
                                                                        @if (User.IsInRole("Admin") || User.IsInRole("Teacher"))
                                                                        {
                                                                            <button type="button"
                                                                                    class="btn btn-sm btn-outline-danger js-file-delete ms-2"
                                                                                    data-file-id="@a.Id"
                                                                                    aria-label="@L["Button.DeleteFile"]">
                                                                                @L["Button.DeleteFile"]
                                                                            </button>
                                                                        }
                                                                    </li>
                                                                }
                                                            </ul>
                                                        </div>
                                                    }

                                                </div>

                                                <div class="text-end ms-3">
                                                    @* hide meet button when recorded video exists *@
                                                    @if (string.IsNullOrEmpty(lesson.RecordedVideoUrl) && !string.IsNullOrEmpty(lesson.MeetUrl))
                                                    {
                                                        <a href="@lesson.MeetUrl" target="_blank" class="btn btn-sm btn-outline-primary mb-1">
                                                            @(L["ReactiveCourse.OpenMeet"] ?? "Open meet")
                                                        </a>
                                                    }

                                                    <button class="btn btn-sm btn-outline-secondary js-edit-lesson mb-1"
                                                            data-lessonid="@lesson.Id"
                                                            data-monthid="@lesson.ReactiveCourseMonthId"
                                                            data-courseid="@Model.Id"
                                                            data-title="@lesson.Title"
                                                            data-scheduled="@lesson.ScheduledUtc?.ToString("o")"
                                                            data-meet="@lesson.MeetUrl"
                                                            data-recorded="@lesson.RecordedVideoUrl"
                                                            data-notes="@lesson.Notes">
                                                        @(L["Button.Edit"] ?? "Edit")
                                                    </button>
                                                    <form class="js-delete-lesson" asp-action="DeleteLesson" method="post" class="d-inline">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="lessonId" value="@lesson.Id" />
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">@((L["Button.Delete"] ?? "Delete"))</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
@*                                         <button type="submit" class="btn btn-sm btn-outline-danger">@((L["Button.Delete"] ?? "Delete"))</button>
 *@                                        <div class="col-md-5">
                                            @if (!string.IsNullOrEmpty(embedUrl))
                                            {
                                                <div class="ratio ratio-16x9">
                                                    <iframe class="lesson-iframe"
                                                            src="@embedUrl"
                                                            loading="lazy"
                                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                            allowfullscreen
                                                            frameborder="0"></iframe>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(lesson.RecordedVideoUrl))
                                            {
                                                @* non-YouTube hosted video *@
                                                <div class="ratio ratio-16x9">
                                                    <video controls style="width:100%;height:100%;object-fit:cover;">
                                                        <source src="@lesson.RecordedVideoUrl" />
                                                        @(L["ReactiveCourse.VideoNotSupported"] ?? "Your browser does not support this video.")
                                                    </video>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(lesson.MeetUrl))
                                            {
                                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="min-height:120px;">
                                                    <small class="text-muted">@(L["ReactiveCourse.Live"] ?? "Live")</small>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="min-height:120px;">
                                                    <small class="text-muted">@(L["ReactiveCourse.NoSchedule"] ?? "No schedule")</small>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>


            </div>
        }
    </div>

    <aside class="col-lg-4">
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <h6>@L["ReactiveCourse.Info"]</h6>
                <dl class="row small">
                    <dt class="col-6 text-muted">@L["ReactiveCourse.Capacity"]</dt>
                    <dd class="col-6 text-end">@Model.Capacity</dd>

                    <dt class="col-6 text-muted">@L["ReactiveCourse.IntroVideo"]</dt>
                    <dd class="col-6 text-end">@(!string.IsNullOrEmpty(Model.IntroVideoUrl) ? L["Yes"] : L["No"])</dd>
                </dl>
            </div>
        </div>
    </aside>
</div>

<div class="modal fade" id="lessonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="lessonModalForm" class="modal-content">
            @Html.AntiForgeryToken()
            <div class="modal-header d-flex align-items-center justify-content-between">
                <h5 class="modal-title" id="lessonModalTitle">@Html.Raw(L["ReactiveCourse.AddLesson"].Value ?? "")</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalCourseId" name="ReactiveCourseId" />
                <input type="hidden" id="modalMonthId" name="ReactiveCourseMonthId" />
                <input type="hidden" id="modalLessonId" name="lessonId" />

                <div class="mb-3">
                    <label class="form-label">@L["ReactiveCourse.LessonTitle"]</label>
                    <input id="modalTitle" name="Title" class="form-control" />
                    <div class="invalid-feedback" id="titleError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">@L["ReactiveCourse.LessonScheduled"]</label>
                    <input id="modalScheduled" name="ScheduledUtc" type="datetime-local" class="form-control" />
                    <div class="invalid-feedback" id="scheduledError"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">@L["ReactiveCourse.LessonMeetUrl"]</label>
                    <input id="modalMeet" name="MeetUrl" class="form-control" />
                    <div class="invalid-feedback" id="meetError"></div>
                    <div class="form-text">@L["ReactiveCourse.LessonMeetUrlHelp"]</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">@L["ReactiveCourse.RecordedVideoUrl"]</label>
                    <input id="modalRecorded" name="RecordedVideoUrl" class="form-control" placeholder="https://youtu.be/..." />
                </div>

                <div class="mb-3">
                    <label class="form-label">@L["Attachments"]</label>
                    <input id="modalAttachments" name="Attachments" type="file" multiple class="form-control" />
                </div>

                <div class="mb-3">
                    <label class="form-label">@L["ReactiveCourse.Notes"]</label>
                    <textarea id="modalNotes" name="Notes" class="form-control" rows="3"></textarea>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@L["Button.Cancel"]</button>
                <button id="modalSaveBtn" type="button" class="btn btn-primary">@L["Button.Save"]</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        (function ($) {
            $(function () {
        // --- localized strings (replace your existing txt object) ---
        var txt = {
            addLesson: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["ReactiveCourse.AddLesson"].Value ?? "Add lesson")),
            editLesson: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["ReactiveCourse.EditLesson"].Value ?? "Edit lesson")),
            titleRequired: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["ReactiveCourse.Validation.TitleRequired"].Value ?? "Title is required")),
            meetUrlInvalid: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["ReactiveCourse.Validation.MeetUrlInvalid"].Value ?? "Invalid meeting URL")),
            serverError: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.ServerError"].Value ?? "Server error")),
            operationFailed: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.OperationFailed"].Value ?? "Operation failed")),
            monthReady: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["ReactiveCourse.MonthReady"].Value ?? "Ready")),
            markReady: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["ReactiveCourse.MarkReady"].Value ?? "Mark ready")),
            commonSuccess: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Common.Success"].Value ?? "Success")),
            commonUpdated: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Common.Updated"].Value ?? "Updated")),
            commonError: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Common.Error"].Value ?? "Error")),

            // strings used by delete handler
            deleteConfirm: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.DeleteConfirm"].Value ?? "Are you sure?")),
            lessonDeleted: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["OnlineCourse.LessonDeleted"].Value ?? "Lesson deleted.")),
            deleteFailed: @Html.Raw(System.Text.Json.JsonSerializer.Serialize("Delete failed.")),
            serverErrorShort: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(L["Admin.ServerError"].Value ?? "Server error"))
        };


                // helper: read antiforgery token
                function getAntiForgeryToken() {
                    var $el = $('input[name="__RequestVerificationToken"]').first();
                    return $el.length ? $el.val() : '';
                }

                // show floating alert (bootstrap-compatible)
                function showAlert(message, type) {
                    type = type || 'success';
                    var $container = $('#alert-container');
                    if (!$container.length) {
                        // fallback: prepend to body
                        $container = $('<div id="alert-container" class="mb-3"></div>').prependTo('body');
                    }
                    var $alert = $('<div>')
                        .addClass('alert alert-' + type + ' alert-dismissible fade show')
                        .attr('role', 'alert')
                        .html(message + ' <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>');
                    $container.append($alert);
                    setTimeout(function () {
                        try { $alert.remove(); } catch (e) { /* ignore */ }
                    }, 4000);
                }

                // basic URL heuristic
                function looksLikeUrl(v) {
                    if (!v) return true;
                    try {
                        var u = new URL(v);
                        return !!u.host;
                    } catch (e) {
                        try {
                            return /zoom|meet|teams|gotomeeting|webex/i.test(v);
                        } catch (_) {
                            return false;
                        }
                    }
                }

                // modal setup
                var $modalEl = $('#lessonModal');
                var bsModal = null;
                function ensureModal() {
                    if (!bsModal && $modalEl.length) bsModal = new bootstrap.Modal($modalEl[0], { backdrop: 'static' });
                }

                // modal DOM refs
                var $modalTitleEl = $('#lessonModalTitle');
                var $modalCourseId = $('#modalCourseId');
                var $modalMonthId = $('#modalMonthId');
                var $modalLessonId = $('#modalLessonId');
                var $modalTitleInput = $('#modalTitle');
                var $modalScheduled = $('#modalScheduled');
                var $modalMeet = $('#modalMeet');
                var $modalNotes = $('#modalNotes');
                var $modalAttachments = $('#modalAttachments');
                var $modalRecorded = $('#modalRecorded');
                var $modalSaveBtn = $('#modalSaveBtn');

                function resetErrors() {
                    $('#titleError,#scheduledError,#meetError').text('');
                    $modalTitleInput.removeClass('is-invalid');
                    $modalScheduled.removeClass('is-invalid');
                    $modalMeet.removeClass('is-invalid');
                }

                // Open Add modal
                $(document).on('click', '.js-add-lesson', function (e) {
                    e.preventDefault();
                    ensureModal();
                    resetErrors();
                    $modalTitleEl.text(txt.addLesson);
                    $modalCourseId.val($(this).data('courseid') || '');
                    $modalMonthId.val($(this).data('monthid') || '');
                    $modalLessonId.val('');
                    $modalTitleInput.val('');
                    $modalScheduled.val('');
                    $modalMeet.val('');
                    $modalNotes.val('');
                    if ($modalAttachments.length) $modalAttachments.val('');
                    if (bsModal) bsModal.show();
                });

                // Open Edit modal
                $(document).on('click', '.js-edit-lesson', function (e) {
                    e.preventDefault();
                    ensureModal();
                    resetErrors();
                    $modalTitleEl.text(txt.editLesson);
                    $modalCourseId.val($(this).data('courseid') || '');
                    $modalMonthId.val($(this).data('monthid') || '');
                    $modalLessonId.val($(this).data('lessonid') || '');
                    $modalTitleInput.val($(this).data('title') || '');
                    var sched = $(this).data('scheduled');
                    $modalScheduled.val(sched ? new Date(sched).toISOString().slice(0,16) : '');
                    $modalMeet.val($(this).data('meet') || '');
                    $modalNotes.val($(this).data('notes') || '');
                    if ($modalAttachments.length) $modalAttachments.val('');
                    if (bsModal) bsModal.show();
                });

                // Save (Add/Edit) handler
                $modalSaveBtn.on('click', function (ev) {
                    ev.preventDefault();
                    resetErrors();

                    var token = getAntiForgeryToken();
                    var isEdit = $modalLessonId.val() && $modalLessonId.val().length > 0;

                    if (!$modalTitleInput.val() || !$modalTitleInput.val().trim()) {
                        $modalTitleInput.addClass('is-invalid');
                        $('#titleError').text(txt.titleRequired);
                        return;
                    }
                    if ($modalMeet.val() && !looksLikeUrl($modalMeet.val())) {
                        $modalMeet.addClass('is-invalid');
                        $('#meetError').text(txt.meetUrlInvalid);
                        return;
                    }

                    var url = isEdit
                        ? '@Url.Action("EditLessonAjax", "ReactiveCourses", new { area = "Teacher" })'
                        : '@Url.Action("AddLessonAjax", "ReactiveCourses", new { area = "Teacher" })';

                    // Build FormData
                    var fd = new FormData();
                    fd.append('__RequestVerificationToken', token);
                    fd.append('ReactiveCourseId', $modalCourseId.val() || '');
                    fd.append('ReactiveCourseMonthId', $modalMonthId.val() || '');
                    if (isEdit) fd.append('lessonId', $modalLessonId.val());
                    fd.append('Title', ($modalTitleInput.val() || '').trim());
                    if ($modalScheduled.val()) fd.append('ScheduledUtc', new Date($modalScheduled.val()).toISOString());
                    if ($modalMeet.val()) fd.append('MeetUrl', ($modalMeet.val() || '').trim());
                    if ($modalRecorded.length && $modalRecorded.val()) fd.append('RecordedVideoUrl', ($modalRecorded.val() || '').trim());
                    if ($modalNotes.val()) fd.append('Notes', ($modalNotes.val() || '').trim());

                    if ($modalAttachments.length && $modalAttachments[0].files && $modalAttachments[0].files.length) {
                        for (var i = 0; i < $modalAttachments[0].files.length; i++) {
                            fd.append('Attachments', $modalAttachments[0].files[i]);
                        }
                    }

                    $.ajax({
                        url: url,
                        method: 'POST',
                        data: fd,
                        processData: false,
                        contentType: false,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        success: function (response, textStatus, jqXHR) {
                            // response may be JSON or text parsed by server. Try conservative handling.
                            var data = response;
                            if (!jqXHR.status || jqXHR.status >= 400) {
                                showAlert(txt.serverError, 'danger');
                                return;
                            }
                            if (data && (data.success === true || data.success === "true")) {
                                if (bsModal) bsModal.hide();
                                location.reload();
                                return;
                            }
                            if (data && data.success === false && data.errors) {
                                if (data.errors.Title) {
                                    $modalTitleInput.addClass('is-invalid');
                                    $('#titleError').text(data.errors.Title);
                                }
                                if (data.errors.MeetUrl) {
                                    $modalMeet.addClass('is-invalid');
                                    $('#meetError').text(data.errors.MeetUrl);
                                }
                                if (data.errors.General) {
                                    showAlert(data.errors.General, 'danger');
                                }
                                return;
                            }
                            showAlert(txt.operationFailed, 'danger');
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            showAlert(txt.serverError, 'danger');
                        }
                    });
                });

                // Delete attachment handler (delegated)
                $(document).on('click', '.js-delete-attachment', function (ev) {
                    ev.preventDefault();
                    var id = $(this).data('id');
                    if (!id) return;
                    if (!confirm('@(L["Admin.DeleteConfirm"].Value ?? "Are you sure?")')) return;

                    var token = getAntiForgeryToken();
                    $.ajax({
                        url: '@Url.Action("DeleteLessonAttachment", "ReactiveCourses", new { area = "Teacher" })',
                        method: 'POST',
                        data: { id: id, __RequestVerificationToken: token },
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        success: function (json) {
                            if (json && json.success) {
                                location.reload();
                            } else {
                                showAlert((json && json.message) ? json.message : 'Delete failed', 'danger');
                            }
                        },
                        error: function () {
                            showAlert(txt.serverError, 'danger');
                        }
                    });
                });

                // Toggle month ready via AJAX (returns {success,...})
                async function postToggleReady(monthId, desiredReady) {
                    var url = '@Url.Action("SetMonthReadyAjax", "ReactiveCourses", new { area = "Teacher" })';
                    var token = getAntiForgeryToken();
                    try {
                        var result = await $.ajax({
                            url: url,
                            method: 'POST',
                            data: JSON.stringify({ monthId: monthId, ready: desiredReady }),
                            contentType: 'application/json',
                            headers: { 'RequestVerificationToken': token, 'X-Requested-With': 'XMLHttpRequest' },
                        });
                        // ensure consistent return shape
                        if (result && (result.success === true || result.success === "true")) return { success: true, data: result };
                        return { success: false, message: (result && result.message) || txt.operationFailed, data: result };
                    } catch (e) {
                        return { success: false, message: txt.serverError, data: null };
                    }
                }

                // attach toggle handlers (optimistic UI + revert on failure)
                $(document).on('click', '.js-toggle-month-ready', async function (e) {
                    e.preventDefault();
                    var $btn = $(this);
                    var currentlyReady = $btn.data('isready') === true || $btn.data('isready') === 'true';
                    var desiredReady = !currentlyReady;
                    var monthId = parseInt($btn.data('monthid'), 10);

                    var originalClass = $btn.attr('class');
                    var originalText = $btn.text();
                    $btn.prop('disabled', true);

                    if (desiredReady) {
                        $btn.removeClass('btn-outline-secondary').addClass('btn-success').text(txt.monthReady);
                    } else {
                        $btn.removeClass('btn-success').addClass('btn-outline-secondary').text(txt.markReady);
                    }

                    var result = await postToggleReady(monthId, desiredReady);

                    if (result.success) {
                        $btn.data('isready', desiredReady ? 'true' : 'false');
                        $btn.attr('aria-pressed', desiredReady ? 'true' : 'false');
                        showAlert(desiredReady ? txt.commonSuccess : txt.commonUpdated, 'success');
                    } else {
                        $btn.attr('class', originalClass);
                        $btn.text(originalText);
                        $btn.data('isready', currentlyReady ? 'true' : 'false');
                        $btn.attr('aria-pressed', currentlyReady ? 'true' : 'false');
                        var msg = result.message || txt.operationFailed;
                        showAlert(msg, 'danger');
                    }

                    $btn.prop('disabled', false);
                });

                // small helper to hide/show icons using dir attribute (LTR/RTL)
                (function dirHelpers() {
                    var htmlDir = document.documentElement.getAttribute('dir') || 'ltr';
                    if (htmlDir === 'rtl') {
                        $('.ltr-only').each(function () { $(this).hide(); });
                    } else {
                        $('.rtl-only').each(function () { $(this).hide(); });
                    }
                })();

        // --- Delete lesson via AJAX (delegated form submit) ---
        $(document).on('submit', '.js-delete-lesson', function (ev) {
            ev.preventDefault();
            var $form = $(this);

            // use serialized localized string instead of inline Razor
            if (!confirm(txt.deleteConfirm)) return;

            var fd = new FormData($form[0]);

            $.ajax({
                url: $form.attr('action'),
                method: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                success: function (json) {
                    if (json && json.success) {
                        // remove lesson container (adjust selector to match markup)
                        var $card = $form.closest('.lesson-card');
                        if (!$card.length) $card = $form.closest('.list-group-item');
                        if ($card.length) $card.remove();
                        else if (json.lessonId) $('[data-lesson-id="' + json.lessonId + '"]').remove();

                        // optional user feedback
                        showAlert(txt.lessonDeleted, 'success');
                    } else {
                        var msg = (json && json.message) ? json.message : txt.deleteFailed;
                        showAlert(msg, 'danger');
                    }
                },
                error: function () {
                    showAlert(txt.serverErrorShort, 'danger');
                }
            });
        });

            }); // document ready
        })(jQuery);
    </script>
}

<style>
    /* minimal direction helpers (no external CSS required) */
    .ltr-only {
        display: inline;
    }

    .rtl-only {
        display: inline;
    }
</style>






