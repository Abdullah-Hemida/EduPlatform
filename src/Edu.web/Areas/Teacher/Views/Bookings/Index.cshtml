@model List<Edu.Web.Areas.Shared.ViewModels.BookingListItemVm>
@using Edu.Domain.Entities
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

@{
    ViewData["Title"] = L["Booking.Index.Title"] ?? "Bookings";

    var request = ViewContext.HttpContext.Request;
    var tab = (ViewData["BookingsTab"] as string) ?? request.Query["tab"].FirstOrDefault() ?? "upcoming";

    int page = (int?)(ViewData["BookingsPage"] as int?) ?? (int.TryParse(request.Query["page"], out var parsedPage) ? parsedPage : 1);
    int pageSize = (int?)(ViewData["BookingsPageSize"] as int?) ?? (int.TryParse(request.Query["pageSize"], out var parsedSize) ? parsedSize : 10);
    int total = (int?)(ViewData["BookingsTotal"] as int?) ?? 0;
    int totalPages = (int)Math.Ceiling(total / (double)pageSize);
}

<h3 class="mb-3">@L["Booking.Title"]</h3>

<nav class="mb-3">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link @(tab == "upcoming" ? "active" : "")" href="@Url.Action("Index", new { tab = "upcoming", page = 1 })">
                @(L["Booking.Tab.Upcoming"] ?? "Upcoming")
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(tab == "past" ? "active" : "")" href="@Url.Action("Index", new { tab = "past", page = 1 })">
                @(L["Booking.Tab.Past"] ?? "Past")
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(tab == "all" ? "active" : "")" href="@Url.Action("Index", new { tab = "all", page = 1 })">
                @(L["Booking.Tab.All"] ?? "All")
            </a>
        </li>
    </ul>
</nav>

@if (!Model.Any())
{
    <div class="alert alert-info">@L["Admin.NoRecords"]</div>
}
else
{
    @* ---------- MOBILE CARDS (sm and smaller) ---------- *@
    <div class="d-block d-md-none mb-3">
        <div class="row row-cols-1 g-2">
            @foreach (var b in Model)
            {
                <div class="col">
                    <div class="card h-100 card-compact shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="min-w-0">
                                    <div class="fw-semibold text-truncate-ellipsis">@b.SlotStartLocalString</div>
                                    <div class="small text-muted text-truncate-ellipsis">@b.SlotTimes</div>
                                </div>

                                <div class="text-nowrap ms-2">
                                    <span class="badge @(b.Status == BookingStatus.Paid ? "bg-success" : b.Status == BookingStatus.Pending ? "bg-warning text-dark" : "bg-secondary")">
                                        @(L[$"Booking.Status.{b.Status}"] ?? b.Status.ToString())
                                    </span>
                                </div>
                            </div>

                            <!-- inside each card (mobile) -->
                            <div class="d-flex align-items-center mb-2 gap-2">
                                <img src="@(string.IsNullOrWhiteSpace(b.StudentImageUrl) ? Url.Content("~/images/default-avatar.png") : b.StudentImageUrl)"
                                     alt="@(b.StudentName ?? "-")"
                                     class="avatar-sm flex-shrink-0" />
                                <div class="min-w-0">
                                    <div class="fw-semibold text-truncate-ellipsis">@(b.StudentName ?? "-")</div>
                                    <div class="small text-muted text-truncate-ellipsis">@(b.StudentPhoneNumber ?? "")</div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center card-meta mb-2">
                                <div class="small text-muted">@(!string.IsNullOrEmpty(b.PriceLabel) ? b.PriceLabel : "-")</div>

                                <div class="small text-muted text-nowrap">@(b.SlotStartLocalString != null ? "" : "")</div>
                            </div>

                            <div class="mt-auto d-grid gap-2">
                                <a asp-action="Details" asp-route-id="@b.Id" class="btn btn-outline-primary btn-sm" role="button">@L["Button.View"]</a>

                                @if (!string.IsNullOrEmpty(b.MeetUrl))
                                {
                                    <a href="@b.MeetUrl" class="btn btn-primary btn-sm" target="_blank" rel="noopener noreferrer">@(L["Booking.OpenMeet"] ?? L["Booking.Meet"])</a>
                                }
                                else if (b.CanJoin)
                                {
                                    <button class="btn btn-outline-secondary btn-sm" disabled>@(L["Booking.NoMeetUrl"] ?? "-")</button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    @* ---------- DESKTOP / TABLET: table (md+) ---------- *@
    <div class="table-responsive d-none d-md-block">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>@L["Slots.Times"]</th>
                    <th>@L["Booking.Student"]</th>
                    <th>@L["Booking.Meet"]</th>
                    <th>@L["Booking.Status"]</th>
                    <th>@L["Booking.Price"]</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var b in Model)
                {
                    <tr>
                        <td style="min-width:160px;">
                            <div class="fw-semibold">@b.SlotStartLocalString</div>
                            <div class="small text-muted">@b.SlotTimes</div>
                        </td>

                        <td style="min-width:180px;">
                            <div class="d-flex align-items-center gap-2">
                                <img src="@(string.IsNullOrWhiteSpace(b.StudentImageUrl) ? Url.Content("~/uploads/images/default-avatar.png") : b.StudentImageUrl)"
                                     alt="@(b.StudentName ?? "-")"
                                     class="avatar-sm flex-shrink-0" />
                                <div class="min-w-0">
                                    <div class="fw-semibold text-truncate-ellipsis">@(b.StudentName ?? "-")</div>
                                    <div class="small text-muted text-truncate-ellipsis">@(b.StudentPhoneNumber ?? "")</div>
                                </div>
                            </div>
                        </td>

                        <td>
                            @if (!string.IsNullOrEmpty(b.MeetUrl))
                            {
                                <a href="@b.MeetUrl" class="btn btn-sm btn-primary" target="_blank" rel="noopener noreferrer">@(L["Booking.OpenMeet"] ?? L["Booking.Meet"])</a>
                            }
                            else
                            {
                                <span class="text-muted">@(L["Booking.NoMeetUrl"] ?? "-")</span>
                            }
                        </td>

                        <td>
                            <span class="badge @(b.Status == BookingStatus.Paid ? "bg-success" : b.Status == BookingStatus.Pending ? "bg-warning text-dark" : "bg-secondary")">
                                @(L[$"Booking.Status.{b.Status}"] ?? b.Status.ToString())
                            </span>
                        </td>

                        <td>@(b.PriceLabel ?? "-")</td>

                        <td class="text-end">
                            <a asp-action="Details" asp-route-id="@b.Id" class="btn btn-sm btn-outline-primary">@L["Button.View"]</a>
                            @if (b.CanJoin && !string.IsNullOrEmpty(b.MeetUrl))
                            {
                                <a href="@b.MeetUrl" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-success ms-1">
                                    <i class="bi bi-play-circle me-1"></i> @(L["Booking.Join"] ?? "Join")
                                </a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* ---------- PAGINATION ---------- *@
    <nav aria-label="Bookings pages" class="mt-3">
        <ul class="pagination justify-content-center">
            @{
                Func<int, string> buildUrl = pageNumber => Url.Action("Index", new { tab = tab, page = pageNumber, pageSize = pageSize });
            }
            <li class="page-item @(page <= 1 ? "disabled" : "")">
                <a class="page-link" href="@buildUrl(page - 1)">&laquo;</a>
            </li>
            @for (int i = Math.Max(1, page - 2); i <= Math.Min(totalPages, page + 2); i++)
            {
                <li class="page-item @(i == page ? "active" : "")">
                    <a class="page-link" href="@buildUrl(i)">@i</a>
                </li>
            }
            <li class="page-item @(page >= totalPages ? "disabled" : "")">
                <a class="page-link" href="@buildUrl(page + 1)">&raquo;</a>
            </li>
        </ul>
    </nav>
}






