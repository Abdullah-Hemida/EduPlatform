@model Edu.Web.Areas.Shared.ViewModels.BookingDetailsVm
@using Edu.Domain.Entities
@using System.Globalization
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

@{
    ViewData["Title"] = L["Booking.Details"] ?? "Booking details";
    var isRtl = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "ar";
    string fallbackAvatar = Url.Content("~/images/default-avatar.png");
}

<div class="row g-3">
    <!-- MAIN COLUMN -->
    <div class="col-lg-8">
        <div class="card mb-3">
            <div class="card-body">
                <!-- header -->
                <div class="d-flex flex-column flex-sm-row align-items-start justify-content-between gap-2 mb-3">
                    <div>
                        <h4 class="mb-0">@L["Booking.Details"]</h4>
                    </div>

                    <div>
                        <a asp-action="Index" class="btn btn-light btn-sm">
                             @L["Common.Back"]
                        </a>
                    </div>
                </div>

                <!-- cover + info: wrap on small screens, order flipped by Bootstrap order-md-* -->
                <div class="d-flex flex-column flex-md-row flex-wrap gap-3">
                    <!-- info -->
                    <div class="flex-grow-1 min-vw-0 @(isRtl ? "order-md-1" : "order-md-2")">

                        <div class="row g-2 mb-3">
                            <div class="col-12 col-sm-6">
                                <div class="small text-muted">@L["Slots.Times"]</div>
                                <div class="fw-semibold text-truncate">@Model.SlotTimes</div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="small text-muted">@L["Booking.Status"]</div>
                                <div>
                                    <span class="badge @(Model.Status == BookingStatus.Paid ? "bg-success" : Model.Status == BookingStatus.Pending ? "bg-warning text-dark" : "bg-secondary")">
                                        @(L[$"Booking.Status.{Model.Status}"] ?? Model.Status.ToString())
                                    </span>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="small text-muted">@L["Booking.Price"]</div>
                                <div class="fw-semibold text-truncate">@Model.PriceLabel</div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="small text-muted">@L["Booking.RequestedAt"]</div>
                                <div class="small text-muted">@Model.RequestedDateUtc.ToLocalTime().ToString("g")</div>
                            </div>
                        </div>

                        <hr class="my-2" />

                        <!-- student info: avatar + details -->
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <img src="@(string.IsNullOrWhiteSpace(Model.StudentImageUrl) ? fallbackAvatar : Model.StudentImageUrl)"
                                 alt="@Model.StudentName"
                                 class="rounded-circle"
                                 style="width:56px;height:56px;object-fit:cover;"
                                 loading="lazy"
                                 onerror="this.onerror=null;this.src='@fallbackAvatar'" />

                            <div class="min-vw-0">
                                <div class="fw-semibold text-truncate">@(Model.StudentName ?? "-")</div>
                                <div class="small text-muted text-truncate">@Model.StudentEmail</div>
                                <div class="small text-muted text-truncate">@Model.StudentPhoneNumber</div>
                                <div>@L["GuardianPhoneNumber"] : @Model.GuardianPhoneNumber</div>
                            </div>
                        </div>

                        <!-- meet and notes in responsive grid
                             align labels to right on md+ when RTL using conditional classes -->
                        <div class="row g-2">
                            <div class="col-12 col-sm-4 @(isRtl ? "text-md-end" : "") text-muted">@L["Booking.Meet"]</div>
                            <div class="col-12 col-sm-8">
                                @if (!string.IsNullOrEmpty(Model.MeetUrl))
                                {
                                    <a href="@Model.MeetUrl" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-primary w-100 w-sm-auto">
                                        @L["Booking.OpenMeet"]
                                    </a>
                                }
                                else
                                {
                                    <span class="text-muted">@L["Booking.NoMeetUrl"]</span>
                                }
                            </div>

                            <div class="col-12 col-sm-4 @(isRtl ? "text-md-end" : "") text-muted">@L["Booking.Notes"]</div>
                            <div class="col-12 col-sm-8">
                                <div class="small">@(!string.IsNullOrWhiteSpace(Model.Notes) ? Model.Notes : "-")</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- moderation logs -->
        <h5 class="mb-2">@L["Admin.Notes"]</h5>
        <ul class="list-group mb-3">
            @if (Model.ModerationLogs == null || !Model.ModerationLogs.Any())
            {
                <li class="list-group-item text-muted">@L["Admin.NoRecords"]</li>
            }
            else
            {
                @foreach (var log in Model.ModerationLogs)
                {
                    <li class="list-group-item">
                        <div class="d-flex flex-column justify-content-center align-items-center">
                            <div class="small text-muted">@log.CreatedAtUtc.ToLocalTime()</div>
                            <div class="small text-muted">@log.ActorName</div>
                        </div>
                        <div class="mt-1"><strong>@log.Action</strong></div>
                        <div class="small text-muted">@log.Note</div>
                    </li>
                }
            }
        </ul>
    </div>
</div>


