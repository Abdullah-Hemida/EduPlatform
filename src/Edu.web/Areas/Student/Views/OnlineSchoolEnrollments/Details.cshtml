@model Edu.Web.Areas.Student.ViewModels.OnlineStudentCourseDetailsVm
@using System.Globalization
@using System.Text.Json
@using Edu.Infrastructure.Helpers
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

@{
    ViewData["Title"] = Model.Title ?? L["OnlineCourse.Details"];
    var lang = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    var dir = lang == "ar" ? "rtl" : "ltr";
    var textAlign = lang == "ar" ? "right" : "left";

    var localizedStrings = new Dictionary<string, string>
    {
        ["EnrollSuccess"] = L["Enroll.Success"].Value ?? "",
        ["EnrollError"] = L["Enroll.Error"].Value ?? "",
        ["PaySuccess"] = L["Pay.Success"].Value ?? "",
        ["PayError"] = L["Pay.Error"].Value ?? "",
        ["CancelSuccess"] = L["Cancel.Success"].Value ?? "",
        ["CancelError"] = L["Cancel.Error"].Value ?? "",

        ["ConfirmEnroll"] = L["Confirm.Enroll"].Value ?? "",
        ["ConfirmPay"] = L["Confirm.Pay"].Value ?? "",
        ["ConfirmCancel"] = L["Confirm.Cancel"].Value ?? "",

        ["StatusPending"] = L["Status.Pending"].Value ?? "",
        ["StatusPaid"] = L["Status.Paid"].Value ?? "",
        ["StatusRejected"] = L["Status.Rejected"].Value ?? "",
        ["NotRequested"] = L["Admin.NotRequested"].Value ?? "",

        ["ReactiveCourse.Enrolled"] = L["ReactiveCourse.Enrolled"].Value ?? "",
        ["ReactiveCourse.CancelEnrollment"] = L["ReactiveCourse.CancelEnrollment"].Value ?? "",
        ["ReactiveCourse.RequestPayment"] = L["ReactiveCourse.RequestPayment"].Value ?? "",
        ["ReactiveCourse.CancelPayment"] = L["ReactiveCourse.CancelPayment"].Value ?? "",
        ["ReactiveCourse.Enroll"] = L["ReactiveCourse.Enroll"].Value ?? "",

        ["Common.Cancel"] = L["Common.Cancel"].Value ?? "Cancel",
        ["Common.Yes"] = L["Common.Yes"].Value ?? "Yes",

        ["Booking.OpenMeet"] = L["Booking.OpenMeet"].Value ?? "",
        ["Booking.NoMeetUrl"] = L["Booking.NoMeetUrl"].Value ?? "",

        // The localized key used for "Month not ready"
        ["MonthNotReady"] = L["ReactiveCourse.MonthNotReady"].Value ?? (L["OnlineCourse.MonthNotReady"].Value ?? "Month not ready")
    };
}

<div class="row g-3" dir="@dir" style="text-align:@textAlign">
    <div class="col-lg-8">
        <div class="card mb-3 shadow-sm">
            @if (!string.IsNullOrEmpty(Model.CoverPublicUrl))
            {
                <img src="@Model.CoverPublicUrl" class="card-img-top" style="height:320px;object-fit:cover" alt="@Model.Title" />
            }
            <div class="card-body">
                <h2>@Model.Title</h2>
                <div class="small text-muted mb-2">@Model.DurationMonths @L["ReactiveCourse.Months"] • @Model.PricePerMonthLabel</div>

                <div class="mt-3">@Html.Raw(Model.Description?.Replace("\n", "<br />"))</div>

                @* Intro video *@
                @if (!string.IsNullOrEmpty(Model.IntroYouTubeId) || !string.IsNullOrEmpty(Model.IntroVideoUrl))
                {
                    <div class="mt-4" id="introVideo">
                        <h6 class="mb-2">@L["ReactiveCourse.IntroVideo"]</h6>
                        @if (!string.IsNullOrEmpty(Model.IntroYouTubeId))
                        {
                            <div class="ratio ratio-16x9 mb-3">
                                <iframe src="https://www.youtube-nocookie.com/embed/@Model.IntroYouTubeId"
                                        referrerpolicy="strict-origin-when-cross-origin"
                                        title="Intro video"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen></iframe>
                            </div>
                        }
                        else
                        {
                            <div class="ratio ratio-16x9 mb-3">
                                <video controls style="width:100%;height:100%;object-fit:cover;">
                                    <source src="@Model.IntroVideoUrl" />
                                    @L["ReactiveCourse.VideoNotSupported"]
                                </video>
                            </div>
                        }
                    </div>
                }

                <div class="mt-4">
                    <div class="d-flex align-items-center justify-content-between mt-2 mb-2">
                        <div class="small text-muted mb-2">@L["ReactiveCourse.Duration"] : @Model.DurationMonths @L["ReactiveCourse.Months"]</div>

                        <div id="enroll-area" data-enrolled="@Model.IsEnrolled.ToString().ToLower()" data-enrollment-id="@(Model.EnrollmentId ?? 0)">
                            @if (User.Identity?.IsAuthenticated == true && User.IsInRole("Student"))
                            {
                                if (!Model.IsEnrolled)
                                {
                                    <button id="btnEnroll" class="btn btn-primary" data-course-id="@Model.CourseId">@L["ReactiveCourse.Enroll"]</button>
                                }
                                else
                                {
                                    var cancelDisabled = Model.HasPendingEnrollment || Model.HasAnyPaidMonth;
                                    <div>
                                        <button id="btnCancelEnroll"
                                                class="btn btn-outline-danger ms-2"
                                                data-course-id="@Model.CourseId"
                                                @(cancelDisabled ? "disabled" : "")>
                                            @L["ReactiveCourse.CancelEnrollment"]
                                        </button>
                                        <span class="badge bg-success ms-2">@L["ReactiveCourse.Enrolled"]</span>
                                    </div>
                                }
                            }
                            else
                            {
                                @* Optionally show nothing for non-students, or show a read-only badge. Example: *@
                                @if (Model.IsEnrolled)
                                {
                                    <span class="badge bg-success ms-2">@L["ReactiveCourse.Enrolled"]</span>
                                }
                            }
                        </div>
                    </div>

                    <div class="list-group" id="months-list">
                        @foreach (var m in Model.Months.OrderBy(x => x.MonthIndex))
                        {
                            var canRequestAttr = m.IsReadyForPayment ? "true" : "false";
                            var canCancelAttr = m.CanCancelPayment ? "true" : "false";
                            var canViewAttr = m.CanViewLessons ? "true" : "false";

                            <div class="list-group-item d-flex justify-content-between align-items-center month-card"
                                 data-month-id="@m.Id"
                                 data-month-index="@m.MonthIndex"
                                 data-payment-id="@(m.PaymentId ?? 0)"
                                 data-can-request="@canRequestAttr"
                                 data-can-cancel="@(m.CanCancelPayment ? "true" : "false")"
                                 data-can-view="@(m.CanViewLessons ? "true" : "false")">
                                <div>
                                    <strong>@L["ReactiveCourse.Month"] @m.MonthIndex</strong>
                                    <div class="small text-muted">@m.LessonsCount @L["ReactiveCourse.Lessons"]</div>
                                </div>

                                <div class="d-flex align-items-center justify-content-end gap-2">
                                    <div class="action-area">

                                        @* ===== PAID: show badge only, nothing else ===== *@
                                        @if (m.MyPaymentStatus == OnlineEnrollmentMonthPaymentStatus.Paid)
                                        {
                                            <span class="badge bg-success">@L["Status.Paid"]</span>
                                        }

                                        @* ===== PENDING ===== *@
                                        else if (m.MyPaymentStatus == OnlineEnrollmentMonthPaymentStatus.Pending)
                                        {
                                            <span class="badge bg-warning text-dark">@L["Status.Pending"]</span>

                                            @if (m.CanCancelPayment)
                                            {
                                                <button class="btn btn-sm btn-outline-danger ms-2 btnCancelPayment"
                                                        data-payment-id="@(m.PaymentId ?? 0)">
                                                    @L["ReactiveCourse.CancelPayment"]
                                                </button>
                                            }
                                        }

                                        @* ===== REJECTED ===== *@
                                        else if (m.MyPaymentStatus == OnlineEnrollmentMonthPaymentStatus.Rejected)
                                        {
                                            <span class="badge bg-danger">@L["Status.Rejected"]</span>

                                            @if (m.IsReadyForPayment && m.CanRequestPayment)
                                            {
                                                <button class="btn btn-sm btn-primary ms-2 btnPayMonth"
                                                        data-month-id="@m.Id"
                                                        data-course-id="@Model.CourseId">
                                                    @L["ReactiveCourse.RequestPayment"]
                                                </button>
                                            }
                                        }

                                        @* ===== NOT REQUESTED YET ===== *@
                                        else
                                        {
                                            if (m.IsReadyForPayment && m.CanRequestPayment)
                                            {
                                                <button class="btn btn-sm btn-primary btnPayMonth"
                                                        data-month-id="@m.Id"
                                                        data-course-id="@Model.CourseId"
                                                        @(Model.IsEnrolled ? "" : "disabled")>
                                                    @L["ReactiveCourse.RequestPayment"]
                                                </button>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@localizedStrings["MonthNotReady"]</span>
                                            }
                                        }

                                    </div>
                                </div>

                            </div>

                            @* Lesson list that is visible only when CanViewLessons is true *@
                            <div id="lesson-@m.Id" class="card mb-2 lesson-list" style="display:@(m.CanViewLessons ? "block" : "none")">
                                <div class="card-body">
                                    <h6>@L["ReactiveCourse.Lessons"] (@L["ReactiveCourse.Month"] @m.MonthIndex)</h6>
                                    @if (m.Lessons != null && m.Lessons.Any())
                                    {
                                        <ul class="list-unstyled">
                                            @foreach (var l in m.Lessons.OrderBy(x => x.ScheduledUtc))
                                            {
                                                <li class="mb-3">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div style="flex:1;min-width:0">
                                                            <strong>@l.Title</strong>
                                                            <div class="small text-muted">@((l.ScheduledUtc.HasValue) ? l.ScheduledUtc.Value.ToLocalTime().ToString("g") : "")</div>

                                                            @* Recorded video (if present) *@
                                                            @if (!string.IsNullOrWhiteSpace(l.RecordedVideoUrl))
                                                            {
                                                                var recYt = YouTubeHelper.ExtractYouTubeId(l.RecordedVideoUrl);
                                                                <div class="mt-2">
                                                                    @if (!string.IsNullOrEmpty(recYt))
                                                                    {
                                                                        <div class="ratio ratio-16x9 mb-2">
                                                                            <iframe src="https://www.youtube-nocookie.com/embed/@recYt"
                                                                                    loading="lazy"
                                                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                                                    allowfullscreen
                                                                                    frameborder="0"></iframe>
                                                                        </div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <div class="ratio ratio-16x9 mb-2">
                                                                            <video controls style="width:100%;height:100%;object-fit:cover;">
                                                                                <source src="@l.RecordedVideoUrl" />
                                                                                @L["ReactiveCourse.VideoNotSupported"]
                                                                            </video>
                                                                        </div>
                                                                    }
                                                                </div>

                                                                @* Attachments (download-only) *@
                                                                @if (l.Files != null && l.Files.Any())
                                                                {
                                                                    <div class="mt-2">
                                                                        <strong class="small">@L["Attachments"]</strong>
                                                                        <ul class="small list-unstyled mt-1 mb-0">
                                                                            @foreach (var f in l.Files)
                                                                            {
                                                                                <li class="mb-1">
                                                                                    @{
                                                                                        // prefer public url (absolute or root-relative). fallback to server Download endpoint if not available.
                                                                                        var href = !string.IsNullOrEmpty(f.PublicUrl) ? f.PublicUrl : (f.DownloadUrl ?? "#");
                                                                                        var displayName = f.FileName ?? ("file-" + f.Id);
                                                                                    }
                                                                                    <a href="@href"
                                                                                       class="js-file-download"
                                                                                       data-file-id="@f.Id"
                                                                                       target="_blank"
                                                                                       rel="noopener noreferrer">
                                                                                        @displayName
                                                                                    </a>
                                                                                </li>
                                                                            }
                                                                        </ul>
                                                                    </div>
                                                                }

                                                            }
                                                            else
                                                            {
                                                                @* No recorded video — show Meet URL if present (for upcoming lessons) *@
                                                                <div class="mt-2">
                                                                    @if (!string.IsNullOrWhiteSpace(l.MeetUrl))
                                                                    {
                                                                        <a class="btn btn-sm btn-primary" target="_blank" href="@l.MeetUrl">@L["Booking.OpenMeet"]</a>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="small text-muted">@L["Booking.NoMeetUrl"]</span>
                                                                    }
                                                                </div>

                                                                @* Attachments (download-only) *@
                                                                @if (l.Files != null && l.Files.Any())
                                                                {
                                                                    <div class="mt-2">
                                                                        <strong class="small">@L["Attachments"]</strong>
                                                                        <ul class="small list-unstyled mt-1 mb-0">
                                                                            @foreach (var f in l.Files)
                                                                            {
                                                                                <li class="mb-1">
                                                                                    @{
                                                                                        // prefer public url (absolute or root-relative). fallback to server Download endpoint if not available.
                                                                                        var href = !string.IsNullOrEmpty(f.PublicUrl) ? f.PublicUrl : (f.DownloadUrl ?? "#");
                                                                                        var displayName = f.FileName ?? ("file-" + f.Id);
                                                                                    }
                                                                                    <a href="@href"
                                                                                       class="js-file-download"
                                                                                       data-file-id="@f.Id"
                                                                                       target="_blank"
                                                                                       rel="noopener noreferrer">
                                                                                        @displayName
                                                                                    </a>
                                                                                </li>
                                                                            }
                                                                        </ul>
                                                                    </div>
                                                                }

                                                            }
                                                        </div>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <div class="small text-muted">@L["ReactiveCourse.NoLessons"]</div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    @* Confirm modal *@
                    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 id="confirmModalTitle" class="modal-title"></h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div id="confirmModalBody" class="modal-body"></div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@L["Common.Cancel"]</button>
                                    <button type="button" id="confirmModalYes" class="btn btn-primary">@L["Common.Yes"]</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    @* antiforgery token *@
                    <form id="af">@Html.AntiForgeryToken()</form>
                </div>
            </div>
        </div>
    </div>

    <aside class="col-lg-4">
        <div class="card sticky-top">
            <div class="card-body">
                <h6>@L["ReactiveCourse.Info"]</h6>
                <p class="small text-muted">@L["ReactiveCourse.InfoForStudent"]</p>
                @if (Model is not null)
                {
                    <p class="small text-muted">@L["ReactiveCourse.PricePerMonth"] : @Model.PricePerMonthLabel</p>
                    <p class="small text-muted">@L["ReactiveCourse.Duration"] : @Model.DurationMonths @L["ReactiveCourse.Months"]</p>
                }
                <a asp-area="Student" asp-controller="OnlineSchoolEnrollments" asp-action="MyEnrollments" class="btn btn-light w-100">@L["Common.Back"]</a>
            </div>
        </div>
    </aside>
</div>

<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 12000;">
    <div id="toast-container"></div>
</div>

<script>
    (function () {
        // keep existing Localized and antiForgeryToken variables in scope
        const Localized = @Html.Raw(JsonSerializer.Serialize(localizedStrings));
        const antiForgeryToken = document.querySelector('#af input[name="__RequestVerificationToken"]').value;

        const actionLocks = {};
        function lock(k) { actionLocks[k] = true; }
        function unlock(k) { delete actionLocks[k]; }
        function isLocked(k) { return !!actionLocks[k]; }

        function showToast(message, type = "success") {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `toast text-bg-${type} border-0`;
            div.setAttribute('role', 'alert');
            div.setAttribute('aria-live', 'assertive');
            div.setAttribute('aria-atomic', 'true');
            div.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            container.appendChild(div);
            const bs = new bootstrap.Toast(div, { delay: 4000 });
            bs.show();
            div.addEventListener('hidden.bs.toast', () => div.remove());
        }

        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const modalEl = document.getElementById('confirmModal');
                document.getElementById('confirmModalTitle').textContent = title || '';
                document.getElementById('confirmModalBody').innerHTML = message || '';

                const bsModal = new bootstrap.Modal(modalEl, { backdrop: 'static' });

                function onHidden() {
                    try {
                        document.activeElement && document.activeElement.blur && document.activeElement.blur();
                    } catch (e) { /* swallow */ }
                    modalEl.removeEventListener('hidden.bs.modal', onHidden);
                    resolve(false);
                }
                modalEl.addEventListener('hidden.bs.modal', onHidden);

                const yesBtn = document.getElementById('confirmModalYes');
                const onYes = () => {
                    yesBtn.removeEventListener('click', onYes);
                    bsModal.hide();
                    setTimeout(() => resolve(true), 150);
                };
                yesBtn.addEventListener('click', onYes);

                bsModal.show();
            });
        }

        function escapeHtml(s) {
            if (s === null || s === undefined) return '';
            return String(s).replace(/[&<>"'`=\/]/g, function (c) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                    '/': '&#x2F;',
                    '`': '&#x60;',
                    '=': '&#x3D;'
                }[c];
            });
        }

        function isAttrTrueString(val) {
            if (!val) return false;
            return /^(?:true|1)$/i.test(String(val).trim());
        }

        function enablePayButtonsIfAllowed() {
            const enrollArea = document.getElementById('enroll-area');
            const enrolled = enrollArea && (enrollArea.getAttribute('data-enrolled') === 'true');

            document.querySelectorAll('.btnPayMonth').forEach(btn => {
                const card = btn.closest('.month-card');
                const canReq = card && isAttrTrueString(card.getAttribute('data-can-request'));
                btn.style.display = '';
                if (enrolled && canReq) {
                    btn.disabled = false;
                } else {
                    btn.disabled = true;
                }
            });
        }

        function setPendingState(monthId, paymentId) {
            const card = document.querySelector(`.month-card[data-month-id='${monthId}']`);
            if (!card) return;
            card.setAttribute('data-payment-id', String(paymentId || 0));
            const action = card.querySelector('.action-area');
            if (action) {
                action.innerHTML = `<span class="badge bg-warning text-dark">${Localized["StatusPending"] || "Pending"}</span>
                                    <button class="btn btn-sm btn-outline-danger ms-2 btnCancelPayment" data-payment-id="${paymentId || 0}">${Localized["ReactiveCourse.CancelPayment"] || "Cancel Payment"}</button>`;
            }
            const badge = card.querySelector('.badge');
            if (badge) { badge.className = 'badge bg-warning text-dark'; badge.textContent = Localized["StatusPending"] || 'Pending'; }
        }

        function setCancelledState(monthId) {
            const card = document.querySelector(`.month-card[data-month-id='${monthId}']`);
            if (!card) return;
            card.setAttribute('data-payment-id', '0');
            const action = card.querySelector('.action-area');
            if (!action) return;
            const canRequest = isAttrTrueString(card.getAttribute('data-can-request'));
            // if month not ready => show localized badge
            if (!canRequest) {
                action.innerHTML = `<span class="badge bg-secondary">${escapeHtml(Localized["MonthNotReady"] || "Month not ready")}</span>`;
            } else {
                const enrolled = document.getElementById('enroll-area')?.getAttribute('data-enrolled') === 'true';
                const disabledAttr = enrolled ? '' : 'disabled';
                action.innerHTML = `<span class="badge bg-secondary">${Localized["NotRequested"] || "Not requested"}</span>
                                    <button class="btn btn-sm btn-primary ms-2 btnPayMonth" data-month-id="${monthId}" data-course-id="@Model.CourseId" ${disabledAttr}>${Localized["ReactiveCourse.RequestPayment"] || "Request Payment"}</button>`;
            }
            const badge = card.querySelector('.badge');
            if (badge) { badge.className = 'badge bg-secondary'; badge.textContent = Localized["NotRequested"] || 'Not requested'; }
        }

        function markEnrolledUI(enrollmentId) {
            const enrollArea = document.getElementById('enroll-area');
            if (!enrollArea) return;

            enrollArea.setAttribute('data-enrolled', 'true');
            enrollArea.setAttribute('data-enrollment-id', String(enrollmentId || 0));

            enrollArea.innerHTML = `<div>
                <button id="btnCancelEnroll" class="btn btn-outline-danger ms-2" data-course-id="${@Model.CourseId}">
                    ${escapeHtml(Localized["ReactiveCourse.CancelEnrollment"] || 'Cancel')}
                </button>
                <span class="badge bg-success ms-2">${escapeHtml(Localized["ReactiveCourse.Enrolled"] || 'Enrolled')}</span>
            </div>`;

            enablePayButtonsIfAllowed();
            updateCancelEnrollState();
        }

        function markEnrollmentCancelledUI() {
            const enrollArea = document.getElementById('enroll-area');
            if (!enrollArea) return;
            enrollArea.setAttribute('data-enrolled', 'false');
            enrollArea.setAttribute('data-enrollment-id', '0');
            enrollArea.innerHTML = `<button id="btnEnroll" class="btn btn-primary" data-course-id="${@Model.CourseId}">${escapeHtml(Localized["ReactiveCourse.Enroll"] || 'Enroll')}</button>`;
            document.querySelectorAll('.btnPayMonth').forEach(btn => { btn.disabled = true; });
            updateCancelEnrollState();
        }

        function updateCancelEnrollState() {
            const btn = document.getElementById('btnCancelEnroll');
            if (!btn) return;
            const hasPendingOrPaid = Array.from(document.querySelectorAll('.month-card'))
                .some(c => c.querySelector('.badge.bg-warning, .badge.bg-success'));
            if (hasPendingOrPaid) {
                btn.disabled = true;
                btn.title = Localized["CancelError"] || '';
            } else {
                btn.disabled = false;
                btn.removeAttribute('title');
            }
        }

        // ---------------- Delegated handlers (enroll / cancel / pay) ----------------
        document.addEventListener('click', async function (ev) {
            const t = ev.target;

            // ENROLL
            if (t.matches('#btnEnroll')) {
                ev.preventDefault();
                const courseId = t.getAttribute('data-course-id');
                const key = `enroll:${courseId}`;
                if (isLocked(key)) return; lock(key);

                try {
                    const confirmed = await showConfirm(Localized["ConfirmEnroll"] || "Confirm", Localized["ConfirmEnroll"] || "Confirm");
                    if (!confirmed) return;
                    const resp = await fetch('/Student/OnlineSchoolEnrollments/Enroll', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `courseId=${encodeURIComponent(courseId)}&__RequestVerificationToken=${encodeURIComponent(antiForgeryToken)}`
                    });

                    let data = null;
                    try {
                        data = await resp.json();
                    } catch (err) { console.error('Enroll: invalid JSON response', err); }

                    if (resp.ok && data && data.success) {
                        showToast(data.message || Localized["EnrollSuccess"] || "Enrolled", "success");
                        markEnrolledUI(data.enrollmentId || 0);
                    } else {
                        const msg = (data && (data.message || data.error)) || `Enroll failed (status ${resp.status})`;
                        showToast(msg, "danger");
                    }
                } catch (ex) {
                    console.error('Enroll exception', ex);
                    showToast(Localized["EnrollError"] || "Error", "danger");
                } finally {
                    unlock(key);
                }
                return;
            }

            // CANCEL ENROLL
            if (t.matches('#btnCancelEnroll')) {
                ev.preventDefault();
                const courseId = t.getAttribute('data-course-id');
                const key = `cancelEnroll:${courseId}`;
                if (isLocked(key)) return; lock(key);

                try {
                    const confirmed = await showConfirm(Localized["ConfirmCancel"] || "Confirm", Localized["ConfirmCancel"] || "Confirm");
                    if (!confirmed) return;

                    const resp = await fetch('/Student/OnlineSchoolEnrollments/CancelEnroll', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `courseId=${encodeURIComponent(courseId)}&__RequestVerificationToken=${encodeURIComponent(antiForgeryToken)}`
                    });

                    let data = null;
                    try { data = await resp.json(); } catch (e) { console.warn('CancelEnroll JSON parse failed', e); }

                    if (resp.ok && data && data.success) {
                        showToast(data.message || Localized["CancelSuccess"] || "Cancelled", "success");
                        markEnrollmentCancelledUI();
                    } else {
                        const msg = (data && (data.message || data.error)) || `Cancel failed (status ${resp.status})`;
                        showToast(msg, "danger");
                        updateCancelEnrollState();
                    }
                } catch (ex) {
                    console.error('CancelEnroll exception', ex);
                    showToast(Localized["CancelError"] || "Error", "danger");
                } finally {
                    unlock(key);
                }
                return;
            }

            // PAY MONTH
            if (t.matches('.btnPayMonth')) {
                ev.preventDefault();
                const monthId = t.getAttribute('data-month-id');
                const courseId = t.getAttribute('data-course-id') || @Model.CourseId;
                const key = `pay:${courseId}:${monthId}`;
                if (isLocked(key)) return; lock(key);

                try {
                    const confirmed = await showConfirm(Localized["ConfirmPay"] || "Confirm", Localized["ConfirmPay"] || "Confirm");
                    if (!confirmed) return;

                    const resp = await fetch('/Student/OnlineSchoolEnrollments/RequestMonthPayment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `monthId=${encodeURIComponent(monthId)}&courseId=${encodeURIComponent(courseId)}&__RequestVerificationToken=${encodeURIComponent(antiForgeryToken)}`
                    });

                    let data = null;
                    try { data = await resp.json(); } catch (e) { console.warn('RequestMonthPayment JSON parse failed', e); }

                    if (resp.ok && data && data.success) {
                        showToast(data.message || Localized["PaySuccess"] || "Requested", "success");
                        setPendingState(monthId, data.paymentId || 0);
                        if (data.enrollmentId) markEnrolledUI(data.enrollmentId);
                    } else {
                        const msg = (data && (data.message || data.error)) || `RequestMonthPayment failed (status ${resp.status})`;
                        showToast(msg, "danger");
                    }
                } catch (ex) {
                    console.error('RequestMonthPayment exception', ex);
                    showToast(Localized["PayError"] || "Error", "danger");
                } finally {
                    unlock(key);
                }
                return;
            }

            // CANCEL PAYMENT
            if (t.matches('.btnCancelPayment')) {
                ev.preventDefault();
                const paymentId = t.getAttribute('data-payment-id');
                const card = t.closest('.month-card');
                const monthId = card ? card.getAttribute('data-month-id') : null;
                const key = `cancelPay:${paymentId}`;
                if (isLocked(key)) return; lock(key);

                try {
                    const confirmed = await showConfirm(Localized["ConfirmCancel"] || "Confirm", Localized["ConfirmCancel"] || "Confirm");
                    if (!confirmed) return;

                    const resp = await fetch('/Student/OnlineSchoolEnrollments/CancelMonthPayment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `paymentId=${encodeURIComponent(paymentId)}&__RequestVerificationToken=${encodeURIComponent(antiForgeryToken)}`
                    });

                    let data = null;
                    try { data = await resp.json(); } catch (e) { console.warn('CancelMonthPayment JSON parse failed', e); }

                    if (resp.ok && data && data.success) {
                        showToast(data.message || Localized["CancelSuccess"] || "Cancelled", "success");
                        if (monthId) setCancelledState(monthId);
                    } else {
                        const msg = (data && (data.message || data.error)) || `CancelMonthPayment failed (status ${resp.status})`;
                        showToast(msg, "danger");
                    }
                } catch (ex) {
                    console.error('CancelMonthPayment exception', ex);
                    showToast(Localized["CancelError"] || "Error", "danger");
                } finally {
                    unlock(key);
                }
                return;
            }
        });

        // run initial activation
        document.addEventListener('DOMContentLoaded', function () {
            enablePayButtonsIfAllowed();
            updateCancelEnrollState();
        });

    })();
</script>




