@model List<Edu.Web.Areas.Shared.ViewModels.BookingListItemVm>
@using Edu.Domain.Entities
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L

@{
    ViewData["Title"] = L["Booking.Index.Title"] ?? "My Bookings";

    var request = ViewContext.HttpContext.Request;
    var tab = (ViewData["BookingsTab"] as string) ?? request.Query["tab"].FirstOrDefault() ?? "upcoming";

    int page = (int?)(ViewData["BookingsPage"] as int?)
        ?? (int.TryParse(request.Query["page"], out var parsedPage) ? parsedPage : 1);

    int pageSize = (int?)(ViewData["BookingsPageSize"] as int?)
        ?? (int.TryParse(request.Query["pageSize"], out var parsedSize) ? parsedSize : 10);

    int total = (int?)(ViewData["BookingsTotal"] as int?) ?? 0;
    int totalPages = (int)Math.Ceiling(total / (double)pageSize);
}

<h3 class="mb-3">@L["Booking.Title"]</h3>

<nav class="mb-3">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link @(tab == "upcoming" ? "active" : "")" href="@Url.Action("MyBookings", new { tab = "upcoming", page = 1 })">
                @(L["Booking.Tab.Upcoming"] ?? "Upcoming")
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(tab == "past" ? "active" : "")" href="@Url.Action("MyBookings", new { tab = "past", page = 1 })">
                @(L["Booking.Tab.Past"] ?? "Past")
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(tab == "all" ? "active" : "")" href="@Url.Action("MyBookings", new { tab = "all", page = 1 })">
                @(L["Booking.Tab.All"] ?? "All")
            </a>
        </li>
    </ul>
</nav>

@if (!Model.Any())
{
    <div class="alert alert-info">@L["Admin.NoRecords"]</div>
}
else
{
    <!-- MOBILE: cards for xs & sm -->
    <div class="d-block d-md-none">
        <div class="row g-2">
            @foreach (var b in Model)
            {
                <div class="col-12">
                    <div class="card booking-card shadow-sm h-100">
                        <div class="card-body d-flex flex-column gap-2">
                            <div class="d-flex align-items-start gap-3">

                                <div class="min-w-0 flex-grow-1">
                                    <div class="d-flex align-items-start justify-content-between">
                                        <div class="min-w-0">
                                            <div class="fw-semibold truncate-inline">@b.SlotStartLocalString</div>
                                            <div class="small text-muted truncate-inline break-any">@b.SlotTimes</div>
                                            <div class="small text-muted mt-1 truncate-inline">@(!string.IsNullOrWhiteSpace(b.TeacherName) ? b.TeacherName : "-")</div>
                                        </div>

                                        <div class="meta-right text-end ms-2">
                                            <span class="badge @(b.Status == BookingStatus.Paid ? "bg-success" : "bg-warning text-dark")">
                                                @(L[$"Booking.Status.{b.Status}"] ?? b.Status.ToString())
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-2 flex-column flex-sm-row">
                                @if (b.CanJoin && !string.IsNullOrWhiteSpace(b.MeetUrl))
                                {
                                    <a href="@b.MeetUrl" target="_blank" rel="noopener noreferrer"
                                       class="btn btn-primary btn-sm btn-collapse-full">
                                        <i class="bi bi-box-arrow-up-right me-1" aria-hidden="true"></i> @(L["Booking.Join"] ?? "Join")
                                    </a>
                                }

                                @if (b.CanCancel)
                                {
                                    <form asp-action="Cancel" method="post" class="m-0 w-100" onsubmit="return confirm('@(L["ConfirmDelete"] ?? "Are you sure?")');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@b.Id" />
                                        <button type="submit" class="btn btn-outline-danger btn-sm btn-collapse-full">@L["Button.Cancel"]</button>
                                    </form>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- DESKTOP / TABLET (md+): table -->
    <div class="table-responsive d-none d-md-block">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="col-times">@L["Slots.Times"]</th>
                    <th class="col-teacher">@L["Booking.Teacher"]</th>
                    <th class="text-center">@L["Booking.Meet"]</th>
                    <th>@L["Booking.Status"]</th>
                    <th>@L["Booking.Price"]</th>
                    <th class="col-actions text-end"></th>
                </tr>
            </thead>

            <tbody>
                @foreach (var b in Model)
                {
                    <tr>
                        <td>
                            <div class="fw-semibold truncate-inline">@b.SlotStartLocalString</div>
                            <div class="small text-muted break-any">@b.SlotTimes</div>
                        </td>

                        <td class="break-any">@(!string.IsNullOrWhiteSpace(b.TeacherName) ? b.TeacherName : "-")</td>

                        <td class="text-center">
                            @if (b.CanJoin && !string.IsNullOrWhiteSpace(b.MeetUrl))
                            {
                                <a href="@b.MeetUrl" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-box-arrow-up-right me-1"></i> @(L["Booking.Join"] ?? "Join")
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>

                        <td>
                            <span class="badge @(b.Status == BookingStatus.Paid ? "bg-success" : "bg-warning text-dark")">
                                @(L[$"Booking.Status.{b.Status}"] ?? b.Status.ToString())
                            </span>
                        </td>

                        <td>@(b.PriceLabel ?? "-")</td>

                        <td class="text-end col-actions">
                            @if (b.CanCancel)
                            {
                                <form asp-action="Cancel" method="post" class="d-inline-block ms-1" onsubmit="return confirm('@(L["ConfirmDelete"] ?? "Are you sure?")');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@b.Id" />
                                    <button type="submit" class="btn btn-sm btn-danger">@L["Button.Cancel"]</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Bookings pages" class="mt-3">
        <ul class="pagination justify-content-center mb-0">
            @{
                Func<int, string> buildUrl = pageNumber => Url.Action("MyBookings", new { tab = tab, page = pageNumber, pageSize = pageSize });
            }
            <li class="page-item @(page <= 1 ? "disabled" : "")">
                <a class="page-link" href="@buildUrl(page - 1)">&laquo;</a>
            </li>
            @for (int i = Math.Max(1, page - 2); i <= Math.Min(totalPages, page + 2); i++)
            {
                <li class="page-item @(i == page ? "active" : "")">
                    <a class="page-link" href="@buildUrl(i)">@i</a>
                </li>
            }
            <li class="page-item @(page >= totalPages ? "disabled" : "")">
                <a class="page-link" href="@buildUrl(page + 1)">&raquo;</a>
            </li>
        </ul>
    </nav>
}








