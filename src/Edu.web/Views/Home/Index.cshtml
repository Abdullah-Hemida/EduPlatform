@model Edu.Web.ViewModels.HomeVm
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> Localizer

@{
    var lang = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    var dir = lang == "ar" ? "rtl" : "ltr";
    var textAlign = lang == "ar" ? "right" : "left";
}

@section Hero {
    @await Html.PartialAsync("_HeroSection", Model.Hero)
}

<main class="site-home" dir="@dir" style="text-align:@textAlign;">
    @for (int idx = 0; idx < Model.Sections.Count; idx++)
    {
        var s = Model.Sections[idx];
        var hasImage = !string.IsNullOrEmpty(s.ImagePublicUrl);
        var alt = idx % 2 == 1;
        var imageFirst = (lang == "ar") ? alt : !alt;
        var items = s.Items ?? Enumerable.Empty<dynamic>();
        var isSingleItem = items.Count() == 1;

        <section class="home-section @(alt ? "alt" : "") border-bottom py-4">
            <div class="container mb-3">
                <h2 class="section-title fw-bold text-center">@s.Title</h2>
                @if (!string.IsNullOrEmpty(s.Subtitle))
                {
                    <p class="section-subtitle text-center text-muted">@s.Subtitle</p>
                }
            </div>

            <div class="container">
                @* When single item we want the row to stretch columns to same height *@
                <div class="section-inner row gx-4 gy-3 @(isSingleItem ? "align-items-stretch" : "align-items-center")">
                    @if (hasImage && imageFirst)
                    {
                        <div class="col-12 col-md-6 section-media order-md-1">
                            <img src="@s.ImagePublicUrl" alt="@s.Title" class="img-fluid w-100 h-100 object-fit-cover" loading="lazy" />
                        </div>
                    }

                    <div class="col-12 @(hasImage ? "col-md-6" : "") section-body">
                        @* Marker classes: no-section-image when there is no main image; single-item when only one item *@
                        <div class="home-items mt-3 @(hasImage ? "" : "no-section-image") @(isSingleItem ? "single-item" : "")">
                            @foreach (var it in items)
                            {
                                <article class="home-item card h-100">
                                    @if (!string.IsNullOrEmpty(it.ImagePublicUrl))
                                    {
                                        <div class="card-img-top item-thumb-wrap">
                                            <img src="@it.ImagePublicUrl" alt="" class="thumb img-fluid w-100" loading="lazy" />
                                        </div>
                                    }

                                    @* Use flex column so we can push the "Read more" to bottom when single-item *@
                                    <div class="card-body d-flex flex-column">
                                        <div id="item-@it.Id" class="item-text flex-grow-1">
                                            @Html.Raw(it.Text)
                                        </div>

                                        @if (!string.IsNullOrEmpty(it.LinkUrl))
                                        {
                                            <a href="@it.LinkUrl" class="read-more btn btn-sm btn-outline-primary mt-3 align-self-start">
                                                @Localizer["Common.ReadMore"] ?? "Read more"
                                                <i class="fa fa-arrow-right ms-1" aria-hidden="true"></i>
                                            </a>
                                        }
                                    </div>
                                </article>
                            }
                        </div>
                    </div>

                    @if (hasImage && !imageFirst)
                    {
                        <div class="col-12 col-md-6 section-media order-md-2">
                            <img src="@s.ImagePublicUrl" alt="@s.Title" class="img-fluid w-100 h-100 object-fit-cover" loading="lazy" />
                        </div>
                    }
                </div>
            </div>
        </section>
    }
</main>


<!-- Status counts footer block (enhanced) -->
<section class="py-5">
    <div class="container text-center">
        <h2 class="fw-bold mb-3">@Localizer["Home.Counts"]</h2>
        <p class="text-muted mb-4">@Localizer["Home.CountsSubtitle"]</p>

        <div class="row g-3 justify-content-center">
            <div class="col-6 col-sm-4 col-md-3">
                <div class="counts-card text-center">
                    <div class="icon text-primary"><i class="fa-solid fa-users"></i></div>
                    <small class="text-muted">@Localizer["Admin.Students"]</small>
                    <h3 class="mt-2 mb-0"><span class="count" data-target="@Model.TotalStudents">0</span></h3>                  
                </div>
            </div>
            <div class="col-6 col-sm-4 col-md-3">
                <div class="counts-card text-center">
                    <div class="icon text-primary"><i class="fa-solid fa-chalkboard-user"></i></div>
                    <small class="text-muted">@Localizer["Admin.Teachers"]</small>
                    <h3 class="mt-2 mb-0"><span class="count" data-target="@Model.TotalTeachers">0</span></h3>
                </div>
            </div>
            <div class="col-6 col-sm-4 col-md-3">
                <div class="counts-card text-center">
                    <div class="icon text-primary"><i class="fa-solid fa-book-open"></i></div>
                    <small class="text-muted">@Localizer["Admin.Curricula"]</small>
                    <h3 class="mt-2 mb-0"><span class="count" data-target="@Model.TotalCurricula">0</span></h3>
                </div>
            </div>
            <div class="col-6 col-sm-4 col-md-3">
                <div class="counts-card text-center">
                    <div class="icon text-primary"><i class="fa-solid fa-video"></i></div>
                    <small class="text-muted">@Localizer["Teacher.RecordedCourses"]</small>
                    <h3 class="mt-2 mb-0"><span class="count" data-target="@Model.TotalPrivateCourses">0</span></h3>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Simple count-up animation when visible
    (function () {
        const counters = document.querySelectorAll('.count');
        if (!counters.length) return;

        const easeOut = t => 1 - Math.pow(1 - t, 3);

        function animate(el, start, end, duration) {
            const startTime = performance.now();
            function tick(now) {
                const elapsed = now - startTime;
                const t = Math.min(1, elapsed / duration);
                const val = Math.floor(start + (end - start) * easeOut(t));
                el.textContent = val.toLocaleString();
                if (t < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }

        const observer = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const el = entry.target;
                    const target = parseInt(el.getAttribute('data-target') || '0', 10);
                    animate(el, 0, target, 900);
                    obs.unobserve(el);
                }
            });
        }, { threshold: 0.35 });

        counters.forEach(c => observer.observe(c));
    })();
</script>




   